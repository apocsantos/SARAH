<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comunica√ß√£o verbal adaptada</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel2:#121a2f; --ink:#e2e8f0; --ink2:#94a3b8;
      --acc:#22d3ee; --acc2:#60a5fa; --mut:#1f2937; --ok:#34d399; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1b 30%,#0b1220);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;min-height:100vh}
    header{display:flex;gap:12px;align-items:center;padding:16px 18px;border-bottom:1px solid #111827;background:rgba(17,24,39,.6);backdrop-filter:saturate(120%) blur(6px)}
    header h1{font-size:clamp(16px,2.5vw,20px);margin:0}
    header .spacer{flex:1}
    .iconBtn{background:#101a32;color:#d1d5db;border:1px solid #1f2a4d;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .iconBtn:hover{outline:1px solid rgba(96,165,250,.4)}

    /* GRID LAYOUT: 2 colunas (paleta + workspace). Quando colapsado ‚Üí 1 coluna */
    main{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;align-items:start}
    body.palette-collapsed main{grid-template-columns:1fr}
    body.palette-collapsed #panelPalette{display:none}

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #0b1020;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .panel h2{font-size:14px;font-weight:700;margin:0;padding:12px 14px;border-bottom:1px solid #0b1020;background:rgba(255,255,255,.03);letter-spacing:.2px;color:#dbeafe}

    /* PALETA STICKY */
    #panelPalette{position:sticky;top:16px;max-height:calc(100vh - 16px - 56px); /* padding - header aprox */ display:flex;flex-direction:column}
    #panelPalette .panel-body{overflow:auto}
    .palette{padding:12px;display:flex;flex-direction:column;gap:10px}
    .block{padding:12px;border-radius:12px;border:1px solid #0b1020;background:linear-gradient(180deg,#111b33,#0f1730);box-shadow:inset 0 1px 0 rgba(255,255,255,.04);cursor:grab;user-select:none;display:flex;gap:8px;align-items:center}
    .block small{display:block;color:var(--ink2)}
    .block:hover{outline:1px solid rgba(96,165,250,.4)}
    .basicHead{font-size:12px;color:#cbd5e1;margin:8px 12px 4px}

    /* Tabs com quebra para m√∫ltiplas linhas */
    .tabs{display:flex;gap:8px;padding:6px 12px 0;flex-wrap:wrap}
    .tab{background:#101a32;border:1px solid #1f2a4d;color:#cbd5e1;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700;font-size:13px}
    .tab.active{background:linear-gradient(90deg,var(--acc2),var(--acc));color:#0a1020;border-color:transparent}

    /* CHIPS GRID responsiva */
    .chips{display:grid;gap:10px;padding:10px 12px 14px;grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
    .chip{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;border:1px solid #0b1020;background:linear-gradient(180deg,#0f1830,#0e1730);cursor:grab;min-height:48px}
    .chip .emo{width:24px;text-align:center;font-size:20px;line-height:1}
    .chip .txt{font-weight:700;color:#e5e7eb;line-height:1.2}

    /* Workspace */
    .workspace{padding:12px}
    .dropzone{border:1.5px dashed #1f2a44;border-radius:12px;padding:12px;min-height:300px;display:flex;flex-direction:column;gap:10px}
    .step{display:flex;gap:10px;align-items:center;background:#0e1730;border:1px solid #1b2441;border-radius:12px;padding:10px;position:relative}
    .step.dropping{outline:2px solid #60a5fa}
    .step .handle{width:16px;height:16px;border-radius:4px;background:linear-gradient(180deg,#1f2f55,#162448);border:1px solid #2a3e72;cursor:grab}
    .ordem{position:absolute;left:28px;top:8px;font-weight:800;font-size:11px;color:#cbd5e1;background:#0e1832;border:1px solid #1c2a4d;border-radius:999px;padding:2px 6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .step input[type="text"], .step input[type="number"]{background:#0b1328;border:1px solid #1c2a4d;color:#e2e8f0;border-radius:8px;padding:8px;min-width:0}
    .step label{font-size:12px;color:#cbd5e1}
    .step .picPrev{width:32px;height:32px;border-radius:6px;background:#0b1220;border:1px solid #1c2a4d;object-fit:contain}
    .step .textDropping{outline:2px dashed #60a5fa}

    .controls{padding:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls .grow{display:flex;gap:10px;flex:1;flex-wrap:wrap}
    button{background:linear-gradient(90deg,var(--acc2),var(--acc));border:none;color:#0a1020;font-weight:800;padding:12px;border-radius:10px;cursor:pointer}
    button.secondary{background:#101a32;color:#d1d5db;border:1px solid #1f2a4d}
    button.warn{background:linear-gradient(90deg,#f97316,#f59e0b);color:#0b1220}
    .btnMove{display:none;padding:8px 10px;font-weight:700}
    .hint{font-size:12px;color:#9fb4d4;padding:10px}

    /* Cores por tipo */
    .step.t-say{background:linear-gradient(180deg,#203046,#1a2741);border-color:#376ba6}
    .step.t-pause{background:linear-gradient(180deg,#2a2f25,#1c2319);border-color:#677a37}
    .step.t-voice{background:linear-gradient(180deg,#262345,#191a33);border-color:#594c9a}

    /* MOBILE: chips maiores e zona de controlo sticky */
    @media (max-width: 900px){
      main{grid-template-columns:1fr}
      #panelPalette{position:static;max-height:none}
      .chips{grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px}
      .chip{min-height:56px;padding:14px}
      .chip .emo{font-size:22px;width:26px}
      .chip .txt{font-size:16px}
      .controls{position:sticky;bottom:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(120%) blur(6px);border-top:1px solid #0b1020}
      .controls .grow{flex-direction:column}
      .controls button{width:100%}
      .btnMove{display:inline-flex}
    }
    @media (max-width: 480px){
      .chips{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
      .chip{min-height:58px;padding:16px}
      .chip .txt{font-size:17px}
    }
  </style>
</head>
<body>
  <header>
    <h1>Construtor de Frases</h1>
    <div class="spacer"></div>
    <button id="btnTogglePalette" class="iconBtn" aria-pressed="false" aria-expanded="true" aria-controls="panelPalette" title="Mostrar/ocultar paleta">‚ò∞ Paleta</button>
  </header>

  <main>
    <!-- PAINEL: Paleta (sticky + scroll interno) -->
    <section class="panel" id="panelPalette">
      <h2>Blocos & Frases</h2>
      <div class="panel-body">
        <div class="palette" id="palette">
          <div class="block" draggable="true" data-type="say">üó£Ô∏è <b>Dizer</b><small>Texto + pictograma (opcional)</small></div>
          <div class="block" draggable="true" data-type="pause">‚è∏Ô∏è <b>Pausa</b><small>Segundos</small></div>
          <div class="block" draggable="true" data-type="voice">üéôÔ∏è <b>Voz/Idioma</b><small>Idioma, velocidade, tom</small></div>
        </div>
        <h3 class="basicHead">Frases (SEED) por categoria</h3>
        <div class="tabs" id="tabs"></div>
        <div class="chips" id="chipsGrid"></div>
        <div class="hint">As tabs podem quebrar para v√°rias linhas. A paleta fica fixa (sticky) em ecr√£s altos.</div>
      </div>
    </section>

    <!-- PAINEL: Workspace -->
    <section class="panel">
      <h2>√Årea de Trabalho</h2>
      <div class="workspace">
        <div id="dropzone" class="dropzone" aria-label="workspace" tabindex="0"></div>
      </div>
      <div class="controls">
        <div class="grow">
          <button id="btnPlay">‚ñ∂ Play</button>
          <button id="btnReset" class="warn">Repor</button>
        </div>
        <button id="btnExport" class="secondary">Exportar JSON</button>
        <input id="fileImport" type="file" accept="application/json,.json" style="display:none" />
        <button id="btnImport" class="secondary">Importar JSON</button>
      </div>
      <div class="hint">Execu√ß√£o: l√™ os blocos na ordem. "Voz/Idioma" define a voz atual; "Pausa" espera; "Dizer" fala o texto.</div>
    </section>
  </main>

  <!-- FAB Play -->
  <button id="fabPlay" class="fab iconBtn" title="Play" aria-label="Play">‚ñ∂</button>

  <script>
  ;(() => {
    'use strict'

    // CONFIG ‚Äî SEED apenas (edita aqui)
    const CONFIG = {
      DEFAULTS: {
        say:   { text: 'Ol√°!', emoji: 'üó£Ô∏è', pic: '' },
        pause: { seconds: 0.8 },
        voice: { lang: 'pt-PT', rate: 1.0, pitch: 1.0 },
      },
      CATEGORIES: [
        { id: 'need',   label: 'Necessidades' },
        { id: 'social', label: 'Sociais' },
        { id: 'action', label: 'A√ß√µes' },
        { id: 'time',   label: 'Tempo' },
        { id: 'home',  label: 'Casa' },
        { id: 'classroom',  label: 'Aulas' },
        { id: 'place',  label: 'Lugares' },
        { id: 'people', label: 'Pessoas' },
        { id: 'feel',   label: 'Sentimentos' },
        { id: 'descrip',label: 'Descri√ß√µes' },
        { id: 'thought', label: 'Pensamentos' },
        { id: 'question', label: 'Perguntas' },
        { id: 'other',  label: 'Outros' },

      ],
      SEED_CHIPS: [
        // Necessidades
        { text: 'Tenho fome.', emoji: 'üçΩÔ∏è', category: 'need' },
        { text: 'Tenho sede.', emoji: 'üíß',  category: 'need' },
        { text: 'Preciso de ir √† casa de banho.', emoji: 'üöª', category: 'need' },
        { text: 'D√≥i-me a cabe√ßa.', emoji: 'ü§ï', category: 'need' },
        { text: 'Quero √°gua.', emoji: 'üö∞', category: 'need' },
        { text: 'Ajuda, por favor.', emoji: 'üÜò', category: 'need' },
        { text: 'Quero passear.', emoji: 'üö∂', category: 'need' },
        { text: 'Quero descansar.', emoji: 'üõå', category: 'need' },
        { text: 'Quero dormir.', emoji: 'üò¥', category: 'need' },
        { text: 'Estou cansado.', emoji: 'üò´', category: 'need' },
        { text: 'Estou doente.', emoji: 'ü§í', category: 'need' },
        { text: 'Estou feliz.', emoji: 'üòä', category: 'need' },
        { text: 'Estou triste.', emoji: 'üò¢', category: 'need' },
        { text: 'Estou com medo.', emoji: 'üò®', category: 'need' },
        { text: 'Estou zangado.', emoji: 'üò†', category: 'need' },
        { text: 'Estou entediado.', emoji: 'üòê', category: 'need' },
        { text: 'Estou confuso.', emoji: 'üòï', category: 'need' },
        { text: 'Estou doente.', emoji: 'ü§í', category: 'need' },
        { text: 'Preciso de ajuda m√©dica.', emoji: 'üè•', category: 'need' },
        { text: 'Preciso de um adulto.', emoji: 'üßë‚Äçü¶≥', category: 'need' },
        { text: 'Preciso de um brinquedo.', emoji: 'üß∏', category: 'need' },
        { text: 'Preciso de um cobertor.', emoji: 'üõèÔ∏è', category: 'need' },
        { text: 'Preciso de um medicamento.', emoji: 'üíä', category: 'need' },
        { text: 'Preciso de um m√©dico.', emoji: 'üë©‚Äç‚öïÔ∏è', category: 'need' },
        { text: 'Preciso de um enfermeiro.', emoji: 'üë®‚Äç‚öïÔ∏è', category: 'need' },
        { text: 'Preciso de um psic√≥logo.', emoji: 'üßë‚Äç‚öïÔ∏è', category: 'need' },
        { text: 'Preciso de um terapeuta.', emoji: 'üßë‚Äç‚öïÔ∏è', category: 'need' },
        { text: 'Preciso de um dentista.', emoji: 'ü¶∑', category: 'need' },
        { text: 'Preciso de um fisioterapeuta.', emoji: 'üßë‚Äç‚öïÔ∏è', category: 'need' },
        { text: 'Preciso de um nutricionista.', emoji: 'üßë‚Äç‚öïÔ∏è', category: 'need' },
        { text: 'Preciso de um psicopedagogo.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um assistente social.', emoji: 'üßë‚Äçüíº', category: 'need' },
        { text: 'Preciso de um advogado.', emoji: 'üßë‚Äç‚öñÔ∏è', category: 'need' },
        { text: 'Preciso de um tradutor.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um int√©rprete.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um guia.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um cuidador.', emoji: 'üßë‚Äç‚öïÔ∏è', category: 'need' },
        { text: 'Preciso de um educador.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um professor.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um treinador.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um mentor.', emoji: 'üßë‚Äçüè´', category: 'need' },
        { text: 'Preciso de um amigo.', emoji: 'ü§ù', category: 'need' },
        { text: 'Preciso de companhia.', emoji: 'üë•', category: 'need' },
        { text: 'Preciso de aten√ß√£o.', emoji: 'üëÄ', category: 'need' },
        { text: 'Preciso de carinho.', emoji: 'ü§ó', category: 'need' },
        { text: 'Preciso de amor.', emoji: '‚ù§Ô∏è', category: 'need' },
        { text: 'Preciso de seguran√ßa.', emoji: 'üõ°Ô∏è', category: 'need' },
        
        //lugares
        { text: 'Quero ir para casa', emoji: 'üè†', category: 'place' },
        { text: 'Quero ir para a escola', emoji: 'üè´', category: 'place' },
        { text: 'Quero ir para o parque', emoji: 'üå≥', category: 'place' },
        { text: 'Quero ir para a loja', emoji: 'üè¨', category: 'place' },
        { text: 'Quero ir para o m√©dico', emoji: 'üè•', category: 'place' },
        { text: 'Quero ir para o dentista', emoji: 'ü¶∑', category: 'place' },
        { text: 'Quero ir para a farm√°cia', emoji: 'üíä', category: 'place' },
        { text: 'Quero ir para o supermercado', emoji: 'üõí', category: 'place' },
        { text: 'Quero ir para o restaurante', emoji: 'üçΩÔ∏è', category: 'place' },
        { text: 'Quero ir para o caf√©', emoji: '‚òï', category: 'place' },
        { text: 'Quero ir para a casa de banho', emoji: 'üöª', category: 'place' },
        { text: 'Quero ir para o jardim', emoji: 'üå∑', category: 'place' },
        { text: 'Quero ir para a praia', emoji: 'üèñÔ∏è', category: 'place' },
        { text: 'Quero ir para a montanha', emoji: 'üèîÔ∏è', category: 'place' },
        { text: 'Quero ir para o lago', emoji: 'üèûÔ∏è', category: 'place' },
        { text: 'Quero ir para o rio', emoji: 'üåä', category: 'place' },
        { text: 'Quero ir para o mar', emoji: 'üåä', category: 'place' },
        { text: 'Quero ir para o zool√≥gico', emoji: 'ü¶Å', category: 'place' },
        { text: 'Quero ir para o aqu√°rio', emoji: 'üê†', category: 'place' },
        { text: 'Quero ir para o museu', emoji: 'üèõÔ∏è', category: 'place' },
        { text: 'Quero ir para o cinema', emoji: 'üé¨', category: 'place' },
        { text: 'Quero ir para o teatro', emoji: 'üé≠', category: 'place' },
        { text: 'Quero ir para o concerto', emoji: 'üéµ', category: 'place' },
        { text: 'Quero ir para a igreja', emoji: '‚õ™', category: 'place' },
        { text: 'Quero ir para a sinagoga', emoji: 'üïç', category: 'place' },
        { text: 'Quero ir para a mesquita', emoji: 'üïå', category: 'place' },
        { text: 'Quero ir para o templo', emoji: 'üõï', category: 'place' },
        { text: 'Quero ir para o parque de divers√µes', emoji: 'üé¢', category: 'place' },
        { text: 'Quero ir para o circo', emoji: 'üé™', category: 'place' },
        { text: 'Quero ir para o est√°dio', emoji: 'üèüÔ∏è', category: 'place' },
        { text: 'Quero ir para o gin√°sio', emoji: 'üèãÔ∏è‚Äç‚ôÇÔ∏è', category: 'place' },
        { text: 'Quero ir para a piscina', emoji: 'üèä‚Äç‚ôÇÔ∏è', category: 'place' },
        { text: 'Quero ir para o spa', emoji: 'üíÜ‚Äç‚ôÄÔ∏è', category: 'place' },
        { text: 'Quero ir para o sal√£o de beleza', emoji: 'üíá‚Äç‚ôÄÔ∏è', category: 'place' },

        //Perguntas
        { text: 'Que horas s√£o?', emoji: '‚ùì', category: 'question' },
        { text: 'Como te chamas?', emoji: '‚ùì', category: 'question' },
        { text: 'Quantos anos tens?', emoji: '‚ùì', category: 'question' },
        { text: 'Onde moras?', emoji: '‚ùì', category: 'question' },
        { text: 'Qual √© a tua cor favorita?', emoji: '‚ùì', category: 'question' },
        { text: 'Qual √© o teu animal favorito?', emoji: '‚ùì', category: 'question' },
        { text: 'Qual √© o teu brinquedo favorito?', emoji: '‚ùì', category: 'question' },
        { text: 'Qual √© a tua comida favorita?', emoji: '‚ùì', category: 'question' },
        { text: 'Qual √© a tua bebida favorita?', emoji: '‚ùì', category: 'question' },
        { text: 'Qual √© o teu desporto favorito?', emoji: '‚ùì', category: 'question' },
        { text: 'Qual √© o teu filme favorito?', emoji: '‚ùì', category: 'question' },

         //Aulas
        { text: 'Eu sei a resposta', emoji: '‚úÖ', category: 'classroom' },
        { text: 'N√£o sei a resposta', emoji: '‚ùå', category: 'classroom' },
        { text: 'Posso ir √† casa de banho?', emoji: 'üöª', category: 'classroom' },
        { text: 'Posso beber √°gua?', emoji: 'üíß', category: 'classroom' },
        { text: 'Posso sair da sala?', emoji: 'üö™', category: 'classroom' },
        { text: 'Preciso de ajuda', emoji: 'üÜò', category: 'classroom' },
        { text: 'N√£o percebo', emoji: 'üòï', category: 'classroom' },
        { text: 'Est√° bem', emoji: 'üëç', category: 'classroom' },
        { text: 'N√£o est√° bem', emoji: 'üëé', category: 'classroom' },
        { text: 'Mais devagar, por favor', emoji: 'üê¢', category: 'classroom' },
        { text: 'Mais alto, por favor', emoji: 'üîä', category: 'classroom' },
        { text: 'Mais baixo, por favor', emoji: 'üîâ', category: 'classroom' },
        { text: 'Repete, por favor', emoji: 'üîÅ', category: 'classroom' },
        { text: 'Escreve no quadro, por favor', emoji: 'üìù', category: 'classroom' },
        { text: 'L√™ em voz alta, por favor', emoji: 'üìñ', category: 'classroom' },
        { text: 'Faz um desenho, por favor', emoji: 'üé®', category: 'classroom' },
        { text: 'Faz uma pausa, por favor', emoji: '‚è∏Ô∏è', category: 'classroom' },
        { text: 'Vamos partilhar!', emoji: 'ü§ù', category: 'classroom' },
        { text: 'Vamos ajudar!', emoji: 'üÜò', category: 'classroom' },
        { text: 'Vamos cuidar!', emoji: '‚ù§Ô∏è', category: 'classroom' },
        { text: 'Vamos respeitar!', emoji: 'üôè', category: 'classroom' },
        { text: 'Pe√ßo desculpa!', emoji: 'üôè', category: 'classroom' },
        { text: 'Obrigado!', emoji: 'üôè', category: 'classroom' },
        { text: 'Bom trabalho!', emoji: 'üëè', category: 'classroom' },
        { text: 'Excelente!', emoji: 'üåü', category: 'classroom' },
        { text: 'Muito bem!', emoji: 'üëç', category: 'classroom' },
        { text: 'Continua assim!', emoji: 'üí™', category: 'classroom' },
        { text: '√âs incr√≠vel!', emoji: 'üåü', category: 'classroom' },
        { text: '√âs especial!', emoji: 'üíñ', category: 'classroom' },
        
        // Sociais
        { text: 'Ol√°!', emoji: 'üëã', category: 'social' },
        { text: 'Obrigado.', emoji: 'üôè', category: 'social' },
        { text: 'Desculpa.', emoji: 'üôá', category: 'social' },
        { text: 'Sim.', emoji: '‚úÖ', category: 'social' },
        { text: 'N√£o.', emoji: '‚ùå', category: 'social' },
        { text: 'Espera, por favor.', emoji: '‚è≥', category: 'social' },
        { text: 'Para, por favor.', emoji: '‚úã', category: 'social' },
        { text: 'Ajuda-me, por favor.', emoji: 'üÜò', category: 'social' },
        { text: 'Quero brincar contigo.', emoji: 'ü§ù', category: 'social' },
        { text: 'Quero estar contigo.', emoji: 'üë•', category: 'social' },
        { text: 'Quero falar contigo.', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Quero ouvir-te.', emoji: 'üëÇ', category: 'social' },
        { text: 'Quero ver-te.', emoji: 'üëÄ', category: 'social' },
        { text: 'Quero abra√ßar-te.', emoji: 'ü§ó', category: 'social' },
        { text: 'Quero beijar-te.', emoji: 'üíã', category: 'social' },
        { text: 'Quero agradecer-te.', emoji: 'üôè', category: 'social' },
        { text: 'Quero pedir desculpa.', emoji: 'üôá', category: 'social' },
        { text: 'Chamo-me ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Tenho ... anos.', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Moro em ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'A minha cor favorita √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O meu animal favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O meu brinquedo favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'A minha comida favorita √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'A minha bebida favorita √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O meu desporto favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O meu filme favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© a tua m√∫sica favorita?', emoji: '‚ùì', category: 'social' },
        { text: 'A minha m√∫sica favorita √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© o teu livro favorito?', emoji: '‚ùì', category: 'social' },
        { text: 'O meu livro favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© a tua s√©rie favorita?', emoji: '‚ùì', category: 'social' },
        { text: 'A minha s√©rie favorita √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© o teu jogo favorito?', emoji: '‚ùì', category: 'social' },
        { text: 'O meu jogo favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© o teu programa favorito?', emoji: '‚ùì', category: 'social' },
        { text: 'O meu programa favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© o teu hobby favorito?', emoji: '‚ùì', category: 'social' },
        { text: 'O meu hobby favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© o teu lugar favorito?', emoji: '‚ùì', category: 'social' },
        { text: 'O meu lugar favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© a tua esta√ß√£o do ano favorita?', emoji: '‚ùì', category: 'social' },
        { text: 'A minha esta√ß√£o do ano favorita √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© o teu dia da semana favorito?', emoji: '‚ùì', category: 'social' },
        { text: 'O meu dia da semana favorito √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'Qual √© a tua hora do dia favorita?', emoji: '‚ùì', category: 'social' },
        { text: 'A minha hora do dia favorita √© ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que gostas de fazer?', emoji: '‚ùì', category: 'social' },
        { text: 'Gosto de ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que n√£o gostas de fazer?', emoji: '‚ùì', category: 'social' },
        { text: 'N√£o gosto de ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz feliz?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico feliz quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz triste?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico triste quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te assusta?', emoji: '‚ùì', category: 'social' },
        { text: 'Tenho medo de ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te deixa zangado?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico zangado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te aborrece?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico aborrecido quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te confunde?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico confuso quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te preocupa?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico preocupado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te deixa entediado?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico entediado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te deixa cansado?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico cansado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te deixa doente?', emoji: '‚ùì', category: 'social' },
        { text: 'Fico doente quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir seguro?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me seguro quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir inseguro?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me inseguro quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir amado?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me amado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir sozinho?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me sozinho quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir feliz?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me feliz quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir triste?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me triste quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir zangado?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me zangado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir assustado?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me assustado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir confuso?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me confuso quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir preocupado?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me preocupado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir entediado?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me entediado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir cansado?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me cansado quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        { text: 'O que te faz sentir doente?', emoji: '‚ùì', category: 'social' },
        { text: 'Sinto-me doente quando ...', emoji: 'üó£Ô∏è', category: 'social' },
        // A√ß√µes
        { text: 'Quero brincar.', emoji: 'üé≤', category: 'action' },
        { text: 'Quero ouvir m√∫sica.', emoji: 'üéµ', category: 'action' },
        { text: 'Quero ver um v√≠deo.', emoji: 'üì∫', category: 'action' },
        { text: 'Quero jogar um jogo.', emoji: 'üéÆ', category: 'action' },
        { text: 'Quero desenhar.', emoji: 'üé®', category: 'action' },
        { text: 'Quero ler um livro.', emoji: 'üìö', category: 'action' },
        { text: 'Quero aprender.', emoji: 'üß†', category: 'action' },
        { text: 'Quero sair.', emoji: 'üö™', category: 'action' },
        { text: 'Quero passear.', emoji: 'üö∂', category: 'action' },
        { text: 'Quero correr.', emoji: 'üèÉ', category: 'action' },
        { text: 'Quero saltar.', emoji: 'ü§∏', category: 'action' },
        { text: 'Quero dan√ßar.', emoji: 'üíÉ', category: 'action' },
        { text: 'Quero cantar.', emoji: 'üé§', category: 'action' },
        { text: 'Quero tocar um instrumento.', emoji: 'üé∏', category: 'action' },
        { text: 'Quero cozinhar.', emoji: 'üë©‚Äçüç≥', category: 'action' },
        { text: 'Quero comer.', emoji: 'üçΩÔ∏è', category: 'action' },
        { text: 'Quero beber.', emoji: 'ü•§', category: 'action' },
        { text: 'Quero nadar.', emoji: 'üèä', category: 'action' },
        { text: 'Quero andar de bicicleta.', emoji: 'üö¥', category: 'action' },
        { text: 'Quero fazer desporto.', emoji: '‚öΩ', category: 'action' },
        { text: 'Quero fazer exerc√≠cio.', emoji: 'üèãÔ∏è', category: 'action' },
        { text: 'Quero meditar.', emoji: 'üßò', category: 'action' },
        { text: 'Quero relaxar.', emoji: 'üõÄ', category: 'action' },
        { text: 'Quero descansar.', emoji: 'üõå', category: 'action' },
        { text: 'Quero dormir.', emoji: 'üò¥', category: 'action' },
        { text: 'Quero sonhar.', emoji: 'üåô', category: 'action' },
        { text: 'Quero viajar.', emoji: '‚úàÔ∏è', category: 'action' },
        { text: 'Quero explorar.', emoji: 'üß≠', category: 'action' },
        { text: 'Quero descobrir.', emoji: 'üîç', category: 'action' },
        { text: 'Quero criar.', emoji: 'üõ†Ô∏è', category: 'action' },
        { text: 'Quero construir.', emoji: 'üèóÔ∏è', category: 'action' },
        { text: 'Quero inventar.', emoji: 'üí°', category: 'action' },
        { text: 'Quero imaginar.', emoji: 'üåà', category: 'action' },
        { text: 'Quero sonhar.', emoji: 'üåô', category: 'action' },
        { text: 'Quero pensar.', emoji: 'ü§î', category: 'action' },
        { text: 'Quero refletir.', emoji: 'ü™û', category: 'action' },
        { text: 'Quero planear.', emoji: 'üóìÔ∏è', category: 'action' },
        { text: 'Quero organizar.', emoji: 'üìÇ', category: 'action' },
      ],
    }

    // Estado + helpers
    let steps=[], activeCat = CONFIG.CATEGORIES[0]?.id || ''
    const qs  = (s, r=document) => r.querySelector(s)
    const makeId = () => 'id_' + Math.random().toString(36).slice(2,9)
    const pretty = t => ({ say:'Dizer', pause:'Pausa', voice:'Voz/Idioma' }[t] || t)
    const chipsGrid = qs('#chipsGrid'), tabs = qs('#tabs'), dropzone = qs('#dropzone')

    // Toggle paleta
    const btnToggle = qs('#btnTogglePalette')
    btnToggle?.addEventListener('click', () => {
      const collapsed = document.body.classList.toggle('palette-collapsed')
      btnToggle.setAttribute('aria-pressed', collapsed ? 'true' : 'false')
      btnToggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true')
    })

    // Tabs + Chips (SEED by category)
    function renderTabs(){
      tabs.innerHTML = ''
      CONFIG.CATEGORIES.forEach((c) => {
        const b = document.createElement('button')
        b.className = 'tab' + (c.id === activeCat ? ' active':'')
        b.textContent = c.label
        b.dataset.id = c.id
        b.addEventListener('click', () => { activeCat = c.id; renderTabs(); renderChips() })
        tabs.appendChild(b)
      })
    }
    function renderChips(){
      chipsGrid.innerHTML = ''
      CONFIG.SEED_CHIPS.filter(ch => ch.category === activeCat).forEach(c => {
        const div = document.createElement('div')
        div.className = 'chip'; div.draggable = true
        div.dataset.phrase = c.text; div.dataset.emoji = c.emoji || ''
        if (c.pic) div.dataset.pic = c.pic
        div.innerHTML = `<span class="emo">${c.emoji || 'üî§'}</span><span class="txt">${c.text || ''}</span>`
        chipsGrid.appendChild(div)
      })
    }

    // click/drag chips
    chipsGrid.addEventListener('click', e => {
      const chip = e.target.closest('.chip'); if(!chip) return
      addStep('say', { text: chip.dataset.phrase||'', emoji: chip.dataset.emoji||'üî§', pic: chip.dataset.pic||'' })
    })
    chipsGrid.addEventListener('dragstart', e => {
      const chip = e.target.closest('.chip'); if(!chip) return
      const payload = { text: chip.dataset.phrase||'', emoji: chip.dataset.emoji||'üî§', pic: chip.dataset.pic||'' }
      try{ e.dataTransfer.setData('application/phrase', JSON.stringify(payload)) }catch{}
      try{ e.dataTransfer.setData('text/plain', 'PHRASE:'+JSON.stringify(payload)) }catch{}
      e.dataTransfer.effectAllowed='copy'
    })

    // Workspace
    function inputText(val, on){ const i=document.createElement('input'); i.type='text'; i.value=val||''; i.oninput=()=>{on(i.value)}; return i }
    function inputNum(val, on){ const i=document.createElement('input'); i.type='number'; i.step='0.1'; i.value=String(val); i.oninput=()=>{on(parseFloat(i.value))}; return i }
    const L = t => { const l=document.createElement('label'); l.textContent=t; return l }

    function buildConfigUI(st){
      const box = document.createElement('div'); box.className='row'; const c = st.conf
      if (st.type==='say'){
        const img=document.createElement('img'); img.className='picPrev'; if(c.pic) img.src=c.pic; else img.style.display='none'
        const emoji=inputText(c.emoji||'', v=>c.emoji=v); emoji.style.width='60px'
        const pic=inputText(c.pic||'', v=>{ c.pic=v; img.style.display=v?'block':'none'; img.src=v||'' }); pic.placeholder='URL pictograma (opcional)'
        const text=inputText(c.text||'', v=>c.text=v)
        text.addEventListener('dragover', e=>{ e.preventDefault(); text.classList.add('textDropping') })
        text.addEventListener('dragleave', ()=> text.classList.remove('textDropping'))
        text.addEventListener('drop', e=>{ e.preventDefault(); text.classList.remove('textDropping'); const p=readPhrasePayload(e.dataTransfer); if(p?.text){ c.text=(c.text?c.text+' ': '')+p.text.trim(); text.value=c.text; } })
        box.append(img, L('emoji'), emoji, L('pictograma'), pic, L('texto'), text)
      }
      if (st.type==='pause'){
        const secs=inputNum(c.seconds ?? CONFIG.DEFAULTS.pause.seconds, v=>c.seconds=v); box.append(L('segundos'), secs)
      }
      if (st.type==='voice'){
        const lang=inputText(c.lang || CONFIG.DEFAULTS.voice.lang, v=>c.lang=v)
        const rate=inputNum(c.rate ?? CONFIG.DEFAULTS.voice.rate, v=>c.rate=v)
        const pitch=inputNum(c.pitch ?? CONFIG.DEFAULTS.voice.pitch, v=>c.pitch=v)
        box.append(L('idioma'), lang, L('velocidade'), rate, L('tom'), pitch)
      }
      return box
    }

    function render(){
      dropzone.innerHTML = ''
      if(!steps.length){ dropzone.innerHTML='<div class="hint">Toca num chip para adicionar rapidamente. Ou larga <b>blocos</b>/<b>frases</b> aqui para come√ßar.</div>'; return }
      steps.forEach((st, idx) => {
        const el=document.createElement('div'); el.className='step t-'+st.type; el.draggable=true
        el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/drag-id', st.id) })
        el.addEventListener('dragover', ev=>{ ev.preventDefault(); el.classList.add('dropping') })
        el.addEventListener('dragleave', ()=> el.classList.remove('dropping'))
        el.addEventListener('drop', ev=>{
          ev.preventDefault(); el.classList.remove('dropping')
          const payload=readPhrasePayload(ev.dataTransfer)
          if(payload?.text){
            if(st.type==='say'){ st.conf.text=(st.conf.text?st.conf.text+' ': '')+payload.text.trim(); render() }
            else { steps.splice(idx,0,{ id:makeId(), type:'say', conf:{ text:payload.text, emoji:payload.emoji||'üî§', pic:payload.pic||'' } }); render() }
            return
          }
          const id=ev.dataTransfer.getData('text/drag-id'); if(!id) return
          const from=steps.findIndex(s=>s.id===id); if(from>-1){ const m=steps.splice(from,1)[0]; steps.splice(idx,0,m); render() }
        })
        const ordem=document.createElement('div'); ordem.className='ordem'; ordem.textContent=String(idx+1)
        const handle=document.createElement('div'); handle.className='handle'; handle.setAttribute('aria-label','Arrastar para reordenar')
        const label=document.createElement('div'); label.style.minWidth='140px'; label.style.fontWeight='700'; label.textContent=pretty(st.type)
        el.append(ordem, handle, label, buildConfigUI(st))

        const actions=document.createElement('div'); actions.style.marginLeft='auto'; actions.style.display='flex'; actions.style.gap='8px'
        const up=Object.assign(document.createElement('button'),{ className:'secondary btnMove', textContent:'‚Üë', title:'Mover para cima', onclick:()=>moveStep(idx,-1) })
        const down=Object.assign(document.createElement('button'),{ className:'secondary btnMove', textContent:'‚Üì', title:'Mover para baixo', onclick:()=>moveStep(idx,1) })
        const dup=Object.assign(document.createElement('button'),{ className:'secondary', textContent:'Duplicar', onclick:()=>{ const copy=JSON.parse(JSON.stringify(st)); copy.id=makeId(); steps.splice(idx+1,0,copy); render() } })
        const del=Object.assign(document.createElement('button'),{ className:'secondary', textContent:'Apagar', onclick:()=>{ steps=steps.filter(s=>s.id!==st.id); render() } })
        actions.append(up,down,dup,del)
        el.append(actions)

        dropzone.appendChild(el)
      })
    }

    function moveStep(index,dir){
      const to=index+dir; if(to<0||to>=steps.length) return
      const m=steps.splice(index,1)[0]; steps.splice(to,0,m); render()
    }

    // Drag helpers
    function readPhrasePayload(dt){
      if(!dt) return null
      const raw=dt.getData('application/phrase'); if(raw){ try{ return JSON.parse(raw) }catch{} }
      const txt=dt.getData('text/plain')
      if(txt && txt.indexOf('{')>-1){ try{ const p=JSON.parse(txt); if(p&&(p.text||p.phrase)) return { text:p.text||p.phrase, emoji:p.emoji||'üî§', pic:p.pic||'' } }catch{} }
      if(txt && txt.indexOf('PHRASE:')===0){ try{ return JSON.parse(txt.slice(7)) }catch{} }
      return null
    }

    // Paleta (adicionar blocos)
    const defaultConfig = type => JSON.parse(JSON.stringify(CONFIG.DEFAULTS[type]||{}))
    function addStep(type,preset){ steps.push({ id:makeId(), type, conf:preset||defaultConfig(type) }); render() }
    const palette = qs('#palette')
    palette?.addEventListener('click', e => { const b=e.target.closest('.block'); if(!b) return; const t=b.dataset.type; if(t) addStep(t) })
    palette?.addEventListener('dragstart', e => { const b=e.target.closest('.block'); if(!b) return; e.dataTransfer.setData('text/block-type', b.dataset.type); e.dataTransfer.setData('text/plain','BLOCK'); e.dataTransfer.effectAllowed='copy' })

    // Drop area
    dropzone?.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.classList.add('dropping') })
    dropzone?.addEventListener('dragleave', ()=> dropzone.classList.remove('dropping'))
    dropzone?.addEventListener('drop', e=>{
      e.preventDefault(); dropzone.classList.remove('dropping')
      const pay=readPhrasePayload(e.dataTransfer); if(pay?.text){ addStep('say',{ text:pay.text, emoji:pay.emoji||'üî§', pic:pay.pic||'' }); return }
      const btype=e.dataTransfer.getData('text/block-type'); if(['say','pause','voice'].includes(btype)) { addStep(btype); return }
      const id=e.dataTransfer.getData('text/drag-id'); if(id){ const from=steps.findIndex(s=>s.id===id); if(from>-1){ const m=steps.splice(from,1)[0]; steps.push(m); render() } }
    })

    // TTS
    const wait = ms => new Promise(res=>setTimeout(res,ms))
    const clamp=(v,min,max)=>Math.min(max, Math.max(min, Number(v)))
    async function speakLines(){
      if(!('speechSynthesis' in window)){ alert('TTS n√£o suportado neste navegador.'); return }
      const synth=window.speechSynthesis
      let current={ ...CONFIG.DEFAULTS.voice, voice:null }
      for(const s of steps){
        const c=s.conf||{}
        if(s.type==='voice'){
          const want=String(c.lang||current.lang).toLowerCase()
          const voices=synth.getVoices()||[]; let v=null
          for(const vv of voices){ const vl=String(vv.lang||'').toLowerCase(); if(vl.indexOf(want)===0){ v=vv; break } }
          current={ lang:c.lang||current.lang, rate:clamp(c.rate ?? current.rate,.5,2), pitch:clamp(c.pitch ?? current.pitch,.5,2), voice:v }
        }else if(s.type==='pause'){
          const ms=Math.max(0, Math.round(Number(c.seconds||0)*1000)); if(ms>0) await wait(ms)
        }else if(s.type==='say'){
          const text=String(c.text||'').trim(); if(!text) continue
          const u=new SpeechSynthesisUtterance(text)
          u.lang=current.lang; u.rate=current.rate; u.pitch=current.pitch; if(current.voice) u.voice=current.voice
          await new Promise(res=>{ u.onend=res; u.onerror=res; synth.speak(u) })
        }
      }
    }

    // Bot√µes
    function hasContent(){ return steps.length>0 && steps.some(s => s.type==='say' && String(s.conf?.text||'').trim().length>0) }
    document.getElementById('btnPlay')?.addEventListener('click', ()=>{ if(!hasContent()) alert('Nada para dizer. Adiciona um bloco \"Dizer\".'); else speakLines() })
    document.getElementById('fabPlay')?.addEventListener('click', ()=>{ if(!hasContent()) alert('Nada para dizer. Adiciona um bloco \"Dizer\".'); else speakLines() })
    document.getElementById('btnReset')?.addEventListener('click', ()=>{ steps=[]; render() })

    // Export/Import de sequ√™ncia
    function exportJSON(){
      const payload = { version: 1, mode: 'tts-blocks', exportedAt: (new Date()).toISOString(), steps }
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' })
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'frases_blocos.json'; a.click(); URL.revokeObjectURL(a.href)
    }
    function importJSONFile(file){
      if(!file) return
      const reader = new FileReader()
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result); const arr = data?.steps
          if(!arr?.length){ alert('JSON sem passos.'); return }
          steps = arr.map(s => ({ id: makeId(), type: s.type, conf: s.conf || (s.type==='say'?{text:''}: (s.type==='pause'?{seconds:0.8}:{lang:'pt-PT',rate:1,pitch:1})) })); render()
        }catch(err){ alert('Falha a ler JSON: '+err.message) }
      }
      reader.readAsText(file)
    }
    document.getElementById('btnExport')?.addEventListener('click', exportJSON)
    document.getElementById('btnImport')?.addEventListener('click', ()=>{ const fi=document.getElementById('fileImport'); fi.value=''; fi.click() })
    document.getElementById('fileImport')?.addEventListener('change', function(){ importJSONFile(this.files?.[0]) })

    // Inicializa√ß√£o
    renderTabs(); renderChips(); render()
  })()
  </script>
</body>
</html>
