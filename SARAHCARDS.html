<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TTS Blocks ‚Äî SEED by Category (Option 1 + Bonus)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel2:#121a2f; --ink:#e2e8f0; --ink2:#94a3b8;
      --acc:#22d3ee; --acc2:#60a5fa; --ok:#34d399; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1b 30%,#0b1220);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;min-height:100vh}
    header{display:flex;gap:12px;align-items:center;padding:16px 18px;border-bottom:1px solid #111827;background:rgba(17,24,39,.6);backdrop-filter:saturate(120%) blur(6px)}
    header h1{font-size:clamp(16px,2.5vw,20px);margin:0}
    header .spacer{flex:1}
    .iconBtn{background:#101a32;color:#d1d5db;border:1px solid #1f2a4d;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .iconBtn:hover{outline:1px solid rgba(96,165,250,.4)}

    /* GRID LAYOUT */
    main{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;align-items:start}
    body.palette-collapsed main{grid-template-columns:1fr}
    body.palette-collapsed #panelPalette{display:none}

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #0b1020;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .panel h2{font-size:14px;font-weight:700;margin:0;padding:12px 14px;border-bottom:1px solid #0b1020;background:rgba(255,255,255,.03);letter-spacing:.2px;color:#dbeafe}

    /* PALETTE STICKY */
    #panelPalette{position:sticky;top:16px;max-height:calc(100vh - 16px - 56px);display:flex;flex-direction:column}
    #panelPalette .panel-body{overflow:auto}
    .palette{padding:12px;display:flex;flex-direction:column;gap:10px}
    .block{padding:12px;border-radius:12px;border:1px solid #0b1020;background:linear-gradient(180deg,#111b33,#0f1730);box-shadow:inset 0 1px 0 rgba(255,255,255,.04);cursor:grab;user-select:none;display:flex;gap:8px;align-items:center}
    .block small{display:block;color:var(--ink2)}
    .block:hover{outline:1px solid rgba(96,165,250,.4)}
    .basicHead{font-size:12px;color:#cbd5e1;margin:8px 12px 4px}

    /* TABS (wrap when needed) */
    .tabs{display:flex;gap:8px;padding:6px 12px 0;flex-wrap:wrap}
    .tab{background:#101a32;border:1px solid #1f2a4d;color:#cbd5e1;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700;font-size:13px}
    .tab.active{background:linear-gradient(90deg,var(--acc2),var(--acc));color:#0a1020;border-color:transparent}

    /* CHIPS GRID */
    .chips{display:grid;gap:10px;padding:10px 12px 14px;grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
    .chip{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;border:1px solid #0b1020;background:linear-gradient(180deg,#0f1830,#0e1730);cursor:grab;min-height:48px}
    .chip .emo{width:26px;height:26px;text-align:center;line-height:1;display:inline-flex;align-items:center;justify-content:center}
    .chip .emo img{width:100%;height:100%;object-fit:contain;display:block}
    .chip .txt{font-weight:700;color:#e5e7eb;line-height:1.2}
    .chip:active{transform:translateY(1px)}

    /* Workspace */
    .workspace{padding:12px}
    .dropzone{border:1.5px dashed #1f2a44;border-radius:12px;padding:12px;min-height:300px;display:flex;flex-direction:column;gap:10px}
    .step{display:flex;gap:10px;align-items:center;background:#0e1730;border:1px solid #1b2441;border-radius:12px;padding:10px;position:relative}
    .step.dropping{outline:2px solid #60a5fa}
    .step .handle{width:16px;height:16px;border-radius:4px;background:linear-gradient(180deg,#1f2f55,#162448);border:1px solid #2a3e72;cursor:grab}
    .ordem{position:absolute;left:28px;top:8px;font-weight:800;font-size:11px;color:#cbd5e1;background:#0e1832;border:1px solid #1c2a4d;border-radius:999px;padding:2px 6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .step input[type="text"], .step input[type="number"]{background:#0b1328;border:1px solid #1c2a4d;color:#e2e8f0;border-radius:8px;padding:8px;min-width:0}
    .step label{font-size:12px;color:#cbd5e1}
    .step .picPrev{width:32px;height:32px;border-radius:6px;background:#0b1220;border:1px solid #1c2a4d;object-fit:contain}
    .step .textDropping{outline:2px dashed #60a5fa}

    .controls{padding:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls .grow{display:flex;gap:10px;flex:1;flex-wrap:wrap}
    button{background:linear-gradient(90deg,var(--acc2),var(--acc));border:none;color:#0a1020;font-weight:800;padding:12px;border-radius:10px;cursor:pointer}
    button.secondary{background:#101a32;color:#d1d5db;border:1px solid #1f2a4d}
    button.warn{background:linear-gradient(90deg,#f97316,#f59e0b);color:#0b1220}
    .btnMove{display:none;padding:8px 10px;font-weight:700}
    .hint{font-size:12px;color:#9fb4d4;padding:10px}

    /* Visually hidden utility (Bonus) */
    .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

    /* Colors per type */
    .step.t-say{background:linear-gradient(180deg,#203046,#1a2741);border-color:#376ba6}
    .step.t-pause{background:linear-gradient(180deg,#2a2f25,#1c2319);border-color:#677a37}
    .step.t-voice{background:linear-gradient(180deg,#262345,#191a33);border-color:#594c9a}

    /* MOBILE */
    @media (max-width: 900px){
      main{grid-template-columns:1fr}
      #panelPalette{position:static;max-height:none}
      .chips{grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px}
      .chip{min-height:56px;padding:14px}
      .chip .emo{width:28px;height:28px}
      .controls{position:sticky;bottom:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(120%) blur(6px);border-top:1px solid #0b1020}
      .controls .grow{flex-direction:column}
      .controls button{width:100%}
      .btnMove{display:inline-flex}
    }
    @media (max-width: 480px){
      .chips{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
      .chip{min-height:58px;padding:16px}
    }
  </style>
</head>
<body>
  <header>
    <h1>TTS Blocks</h1>
    <div class="spacer"></div>
    <button id="btnTogglePalette" class="iconBtn" aria-pressed="false" aria-expanded="true" aria-controls="panelPalette" title="Show/hide palette">‚ò∞ Palette</button>
  </header>

  <main>
    <!-- Sticky PALETTE -->
    <section class="panel" id="panelPalette">
      <h2>Blocks & Phrases</h2>
      <div class="panel-body">
        <div class="palette" id="palette">
          <div class="block" draggable="true" data-type="say">üó£Ô∏è <b>Say</b><small>Text + pictogram (optional)</small></div>
          <div class="block" draggable="true" data-type="pause">‚è∏Ô∏è <b>Pause</b><small>Seconds</small></div>
          <div class="block" draggable="true" data-type="voice">üéôÔ∏è <b>Voice/Locale</b><small>Language, rate, pitch</small></div>
        </div>
        <h3 class="basicHead">Phrases (SEED) per category</h3>
        <div class="tabs" id="tabs"></div>
        <div class="chips" id="chipsGrid"></div>
        <div class="hint">Each chip uses <b>pic</b> when available (PNG/SVG URL or data URI). The text is visually hidden but kept as accessible name and TTS content.</div>
      </div>
    </section>

    <!-- WORKSPACE -->
    <section class="panel">
      <h2>Workspace</h2>
      <div class="workspace">
        <div id="dropzone" class="dropzone" aria-label="workspace" tabindex="0"></div>
      </div>
      <div class="controls">
        <div class="grow">
          <button id="btnPlay">‚ñ∂ Play</button>
          <button id="btnReset" class="warn">Reset</button>
        </div>
        <button id="btnExport" class="secondary">Export JSON</button>
        <input id="fileImport" type="file" accept="application/json,.json" style="display:none" />
        <button id="btnImport" class="secondary">Import JSON</button>
      </div>
      <div class="hint">Execution reads blocks in order. "Voice/Locale" sets the current voice; "Pause" waits; "Say" speaks the text.</div>
    </section>
  </main>

  <button id="fabPlay" class="fab iconBtn" title="Play" aria-label="Play" style="position:fixed;right:16px;bottom:16px;border-radius:50%;">‚ñ∂</button>

  <script>
  ;(() => {
    'use strict'

    // CONFIG ‚Äî add pic URLs (PNG/SVG or data URIs). Text remains for TTS.
    const CONFIG = {
      DEFAULTS: {
        say:   { text: 'Hello!', emoji: 'üó£Ô∏è', pic: '' },
        pause: { seconds: 0.8 },
        voice: { lang: 'pt-PT', rate: 1.0, pitch: 1.0 },
      },
      CATEGORIES: [
        { id: 'need',   label: 'Needs' },
        { id: 'social', label: 'Social' },
        { id: 'action', label: 'Actions' },
      ],
      SEED_CHIPS: [
        // Needs (with sample icons as external URLs)
        { text: 'Tenho fome.', category: 'need',  pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f37d.svg' },
        { text: 'Tenho sede.', category: 'need',  pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f4a7.svg' },
        { text: 'Preciso de ir √† casa de banho.', category: 'need',  pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f6bb.svg' },
        { text: 'D√≥i-me a cabe√ßa.', category: 'need',  pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f915.svg' },
        { text: 'Quero √°gua.', category: 'need',  pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f6b0.svg' },
        { text: 'Ajuda, por favor.', category: 'need',  pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f198.svg' },
        // Social
        { text: 'Ol√°!', category: 'social', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f44b.svg' },
        { text: 'Obrigado.', category: 'social', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f64f.svg' },
        { text: 'Desculpa.', category: 'social', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f647.svg' },
        { text: 'Sim.', category: 'social', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/2705.svg' },
        { text: 'N√£o.', category: 'social', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/274c.svg' },
        { text: 'Espera, por favor.', category: 'social', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/23f3.svg' },
        { text: 'Para, por favor.', category: 'social', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/270b.svg' },
        // Actions
        { text: 'Quero brincar.', category: 'action', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f3b2.svg' },
        { text: 'Quero ouvir m√∫sica.', category: 'action', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f3b5.svg' },
        { text: 'Quero ver um v√≠deo.', category: 'action', pic: 'https://raw.githubusercontent.com/twitter/twemoji/14.0.2/assets/svg/1f4fa.svg' },
      ],
    }

    // State + helpers
    let steps=[], activeCat = CONFIG.CATEGORIES[0]?.id || ''
    const qs  = (s, r=document) => r.querySelector(s)
    const makeId = () => 'id_' + Math.random().toString(36).slice(2,9)
    const pretty = t => ({ say:'Say', pause:'Pause', voice:'Voice/Locale' }[t] || t)
    const chipsGrid = qs('#chipsGrid'), tabs = qs('#tabs'), dropzone = qs('#dropzone')

    // Toggle palette
    const btnToggle = qs('#btnTogglePalette')
    btnToggle?.addEventListener('click', () => {
      const collapsed = document.body.classList.toggle('palette-collapsed')
      btnToggle.setAttribute('aria-pressed', collapsed ? 'true' : 'false')
      btnToggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true')
    })

    // Tabs + Chips (SEED only)
    function renderTabs(){
      tabs.innerHTML = ''
      CONFIG.CATEGORIES.forEach((c) => {
        const b = document.createElement('button')
        b.className = 'tab' + (c.id === activeCat ? ' active':'')
        b.textContent = c.label
        b.dataset.id = c.id
        b.addEventListener('click', () => { activeCat = c.id; renderTabs(); renderChips() })
        tabs.appendChild(b)
      })
    }
    function renderChips(){
      chipsGrid.innerHTML = ''
      CONFIG.SEED_CHIPS.filter(ch => ch.category === activeCat).forEach(c => {
        const div = document.createElement('div')
        div.className = 'chip'; div.draggable = true
        div.dataset.phrase = c.text; // TTS uses text
        if (c.pic) div.dataset.pic = c.pic
        if (c.emoji) div.dataset.emoji = c.emoji
        // Accessible name uses the text, text is visually hidden in the tile
        div.setAttribute('aria-label', c.text || '')
        const icon = c.pic ? `<img src="${c.pic}" alt="">` : (c.emoji || 'üî§')
        div.innerHTML = `<span class="emo" aria-hidden="true">${icon}</span><span class="txt visually-hidden">${c.text || ''}</span>`
        chipsGrid.appendChild(div)
      })
    }

    // click/drag chips
    chipsGrid.addEventListener('click', e => {
      const chip = e.target.closest('.chip'); if(!chip) return
      addStep('say', { text: chip.dataset.phrase||'', emoji: chip.dataset.emoji||'üî§', pic: chip.dataset.pic||'' })
    })
    chipsGrid.addEventListener('dragstart', e => {
      const chip = e.target.closest('.chip'); if(!chip) return
      const payload = { text: chip.dataset.phrase||'', emoji: chip.dataset.emoji||'üî§', pic: chip.dataset.pic||'' }
      try{ e.dataTransfer.setData('application/phrase', JSON.stringify(payload)) }catch{}
      try{ e.dataTransfer.setData('text/plain', 'PHRASE:'+JSON.stringify(payload)) }catch{}
      e.dataTransfer.effectAllowed='copy'
    })

    // Workspace
    function inputText(val, on){ const i=document.createElement('input'); i.type='text'; i.value=val||''; i.oninput=()=>{on(i.value)}; return i }
    function inputNum(val, on){ const i=document.createElement('input'); i.type='number'; i.step='0.1'; i.value=String(val); i.oninput=()=>{on(parseFloat(i.value))}; return i }
    const L = t => { const l=document.createElement('label'); l.textContent=t; return l }

    function buildConfigUI(st){
      const box = document.createElement('div'); box.className='row'; const c = st.conf
      if (st.type==='say'){
        const img=document.createElement('img'); img.className='picPrev'; if(c.pic) img.src=c.pic; else img.style.display='none'
        const emoji=inputText(c.emoji||'', v=>c.emoji=v); emoji.style.width='60px'
        const pic=inputText(c.pic||'', v=>{ c.pic=v; img.style.display=v?'block':'none'; img.src=v||'' }); pic.placeholder='Pictogram URL (optional)'
        const text=inputText(c.text||'', v=>c.text=v)
        text.addEventListener('dragover', e=>{ e.preventDefault(); text.classList.add('textDropping') })
        text.addEventListener('dragleave', ()=> text.classList.remove('textDropping'))
        text.addEventListener('drop', e=>{ e.preventDefault(); text.classList.remove('textDropping'); const p=readPhrasePayload(e.dataTransfer); if(p?.text){ c.text=(c.text?c.text+' ': '')+p.text.trim(); text.value=c.text; } })
        box.append(img, L('emoji'), emoji, L('pictogram'), pic, L('text'), text)
      }
      if (st.type==='pause'){
        const secs=inputNum(c.seconds ?? CONFIG.DEFAULTS.pause.seconds, v=>c.seconds=v); box.append(L('seconds'), secs)
      }
      if (st.type==='voice'){
        const lang=inputText(c.lang || CONFIG.DEFAULTS.voice.lang, v=>c.lang=v)
        const rate=inputNum(c.rate ?? CONFIG.DEFAULTS.voice.rate, v=>c.rate=v)
        const pitch=inputNum(c.pitch ?? CONFIG.DEFAULTS.voice.pitch, v=>c.pitch=v)
        box.append(L('lang'), lang, L('rate'), rate, L('pitch'), pitch)
      }
      return box
    }

    function render(){
      dropzone.innerHTML = ''
      if(!steps.length){ dropzone.innerHTML='<div class="hint">Tap a chip to add quickly. Or drop <b>blocks</b>/<b>phrases</b> here to start.</div>'; return }
      steps.forEach((st, idx) => {
        const el=document.createElement('div'); el.className='step t-'+st.type; el.draggable=true
        el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/drag-id', st.id) })
        el.addEventListener('dragover', ev=>{ ev.preventDefault(); el.classList.add('dropping') })
        el.addEventListener('dragleave', ()=> el.classList.remove('dropping'))
        el.addEventListener('drop', ev=>{
          ev.preventDefault(); el.classList.remove('dropping')
          const payload=readPhrasePayload(ev.dataTransfer)
          if(payload?.text){
            if(st.type==='say'){ st.conf.text=(st.conf.text?st.conf.text+' ': '')+payload.text.trim(); render() }
            else { steps.splice(idx,0,{ id:makeId(), type:'say', conf:{ text:payload.text, emoji:payload.emoji||'üî§', pic:payload.pic||'' } }); render() }
            return
          }
          const id=ev.dataTransfer.getData('text/drag-id'); if(!id) return
          const from=steps.findIndex(s=>s.id===id); if(from>-1){ const m=steps.splice(from,1)[0]; steps.splice(idx,0,m); render() }
        })
        const ordem=document.createElement('div'); ordem.className='ordem'; ordem.textContent=String(idx+1)
        const handle=document.createElement('div'); handle.className='handle'; handle.setAttribute('aria-label','Drag to reorder')
        const label=document.createElement('div'); label.style.minWidth='140px'; label.style.fontWeight='700'; label.textContent=pretty(st.type)
        el.append(ordem, handle, label, buildConfigUI(st))

        const actions=document.createElement('div'); actions.style.marginLeft='auto'; actions.style.display='flex'; actions.style.gap='8px'
        const up=Object.assign(document.createElement('button'),{ className:'secondary btnMove', textContent:'‚Üë', title:'Move up', onclick:()=>moveStep(idx,-1) })
        const down=Object.assign(document.createElement('button'),{ className:'secondary btnMove', textContent:'‚Üì', title:'Move down', onclick:()=>moveStep(idx,1) })
        const dup=Object.assign(document.createElement('button'),{ className:'secondary', textContent:'Duplicate', onclick:()=>{ const copy=JSON.parse(JSON.stringify(st)); copy.id=makeId(); steps.splice(idx+1,0,copy); render() } })
        const del=Object.assign(document.createElement('button'),{ className:'secondary', textContent:'Delete', onclick:()=>{ steps=steps.filter(s=>s.id!==st.id); render() } })
        actions.append(up,down,dup,del)
        el.append(actions)

        dropzone.appendChild(el)
      })
    }

    function moveStep(index,dir){
      const to=index+dir; if(to<0||to>=steps.length) return
      const m=steps.splice(index,1)[0]; steps.splice(to,0,m); render()
    }

    // Drag helpers
    function readPhrasePayload(dt){
      if(!dt) return null
      const raw=dt.getData('application/phrase'); if(raw){ try{ return JSON.parse(raw) }catch{} }
      const txt=dt.getData('text/plain')
      if(txt && txt.indexOf('{')>-1){ try{ const p=JSON.parse(txt); if(p&&(p.text||p.phrase)) return { text:p.text||p.phrase, emoji:p.emoji||'üî§', pic:p.pic||'' } }catch{} }
      if(txt && txt.indexOf('PHRASE:')===0){ try{ return JSON.parse(txt.slice(7)) }catch{} }
      return null
    }

    // Palette (add blocks)
    const defaultConfig = type => JSON.parse(JSON.stringify(CONFIG.DEFAULTS[type]||{}))
    function addStep(type,preset){ steps.push({ id:makeId(), type, conf:preset||defaultConfig(type) }); render() }
    const palette = qs('#palette')
    palette?.addEventListener('click', e => { const b=e.target.closest('.block'); if(!b) return; const t=b.dataset.type; if(t) addStep(t) })
    palette?.addEventListener('dragstart', e => { const b=e.target.closest('.block'); if(!b) return; e.dataTransfer.setData('text/block-type', b.dataset.type); e.dataTransfer.setData('text/plain','BLOCK'); e.dataTransfer.effectAllowed='copy' })

    // Drop area
    dropzone?.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.classList.add('dropping') })
    dropzone?.addEventListener('dragleave', ()=> dropzone.classList.remove('dropping'))
    dropzone?.addEventListener('drop', e=>{
      e.preventDefault(); dropzone.classList.remove('dropping')
      const pay=readPhrasePayload(e.dataTransfer); if(pay?.text){ addStep('say',{ text:pay.text, emoji:pay.emoji||'üî§', pic:pay.pic||'' }); return }
      const btype=e.dataTransfer.getData('text/block-type'); if(['say','pause','voice'].includes(btype)) { addStep(btype); return }
      const id=e.dataTransfer.getData('text/drag-id'); if(id){ const from=steps.findIndex(s=>s.id===id); if(from>-1){ const m=steps.splice(from,1)[0]; steps.push(m); render() } }
    })

    // TTS
    const wait = ms => new Promise(res=>setTimeout(res,ms))
    const clamp=(v,min,max)=>Math.min(max, Math.max(min, Number(v)))
    async function speakLines(){
      if(!('speechSynthesis' in window)){ alert('TTS not supported in this browser.'); return }
      const synth=window.speechSynthesis
      let current={ ...CONFIG.DEFAULTS.voice, voice:null }
      for(const s of steps){
        const c=s.conf||{}
        if(s.type==='voice'){
          const want=String(c.lang||current.lang).toLowerCase()
          const voices=synth.getVoices()||[]; let v=null
          for(const vv of voices){ const vl=String(vv.lang||'').toLowerCase(); if(vl.indexOf(want)===0){ v=vv; break } }
          current={ lang:c.lang||current.lang, rate:clamp(c.rate ?? current.rate,.5,2), pitch:clamp(c.pitch ?? current.pitch,.5,2), voice:v }
        }else if(s.type==='pause'){
          const ms=Math.max(0, Math.round(Number(c.seconds||0)*1000)); if(ms>0) await wait(ms)
        }else if(s.type==='say'){
          const text=String(c.text||'').trim(); if(!text) continue
          const u=new SpeechSynthesisUtterance(text)
          u.lang=current.lang; u.rate=current.rate; u.pitch=current.pitch; if(current.voice) u.voice=current.voice
          await new Promise(res=>{ u.onend=res; u.onerror=res; synth.speak(u) })
        }
      }
    }

    // Buttons
    function hasContent(){ return steps.length>0 && steps.some(s => s.type==='say' && String(s.conf?.text||'').trim().length>0) }
    document.getElementById('btnPlay')?.addEventListener('click', ()=>{ if(!hasContent()) alert('Nothing to say. Add a "Say" block.'); else speakLines() })
    document.getElementById('fabPlay')?.addEventListener('click', ()=>{ if(!hasContent()) alert('Nothing to say. Add a "Say" block.'); else speakLines() })
    document.getElementById('btnReset')?.addEventListener('click', ()=>{ steps=[]; render() })

    // Export/Import
    function exportJSON(){
      const payload = { version: 1, mode: 'tts-blocks', exportedAt: (new Date()).toISOString(), steps }
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' })
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'phrases_blocks.json'; a.click(); URL.revokeObjectURL(a.href)
    }
    function importJSONFile(file){
      if(!file) return
      const reader = new FileReader()
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result); const arr = data?.steps
          if(!arr?.length){ alert('JSON has no steps.'); return }
          steps = arr.map(s => ({ id: makeId(), type: s.type, conf: s.conf || (s.type==='say'?{text:''}: (s.type==='pause'?{seconds:0.8}:{lang:'pt-PT',rate:1,pitch:1})) })); render()
        }catch(err){ alert('Failed to read JSON: '+err.message) }
      }
      reader.readAsText(file)
    }
    document.getElementById('btnExport')?.addEventListener('click', exportJSON)
    document.getElementById('btnImport')?.addEventListener('click', ()=>{ const fi=document.getElementById('fileImport'); fi.value=''; fi.click() })
    document.getElementById('fileImport')?.addEventListener('change', function(){ importJSONFile(this.files?.[0]) })

    // Init
    renderTabs(); renderChips(); render()
  })()
  </script>
</body>
</html>
