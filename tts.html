<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Construtor de Frases por Blocos (TTS)</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--panel2:#121a2f;--ink:#e2e8f0;--ink2:#94a3b8;--acc:#22d3ee;--acc2:#60a5fa;--mut:#1f2937;--ok:#34d399;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1b 30%,#0b1220);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;min-height:100vh}
    header{display:flex;gap:12px;align-items:center;padding:16px 18px;border-bottom:1px solid #111827;background:rgba(17,24,39,.6);backdrop-filter:saturate(120%) blur(6px)}
    header h1{font-size:18px;margin:0}
    header .pill{margin-left:auto;padding:4px 8px;border-radius:999px;background:#0e1832;border:1px solid #1c2a4d;color:#cbd5e1;font-size:12px}

    /* Layout base */
    main{display:grid;grid-template-columns:280px 1fr 420px;gap:16px;padding:16px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #0b1020;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .panel h2{font-size:14px;font-weight:700;margin:0;padding:12px 14px;border-bottom:1px solid #0b1020;background:rgba(255,255,255,.03);letter-spacing:.2px;color:#dbeafe}

    /* Paleta */
    .palette{padding:12px;display:flex;flex-direction:column;gap:10px}
    .block{padding:12px;border-radius:12px;border:1px solid #0b1020;background:linear-gradient(180deg,#111b33,#0f1730);box-shadow:inset 0 1px 0 rgba(255,255,255,.04);cursor:grab;user-select:none;display:flex;gap:8px;align-items:center}
    .block small{display:block;color:var(--ink2)}
    .block:hover{outline:1px solid rgba(96,165,250,.4)}

    /* Frases b√°sicas */
    .basicHead{font-size:12px;color:#cbd5e1;margin:8px 12px 4px}
    .tabs{display:flex;gap:8px;padding:6px 12px 0}
    .tab{background:#101a32;border:1px solid #1f2a4d;color:#cbd5e1;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:700;font-size:12px}
    .tab.active{background:linear-gradient(90deg,var(--acc2),var(--acc));color:#0a1020;border-color:transparent}
    .chips{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;padding:0 12px 12px}
    .chip{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid #0b1020;background:linear-gradient(180deg,#0f1830,#0e1730);cursor:grab}
    .chip .emo{width:22px;text-align:center}
    .chip .txt{font-weight:700;color:#e5e7eb}

    /* Workspace */
    .workspace{padding:12px}
    .dropzone{border:1.5px dashed #1f2a44;border-radius:12px;padding:12px;min-height:220px;display:flex;flex-direction:column;gap:10px}
    .step{display:flex;gap:10px;align-items:center;background:#0e1730;border:1px solid #1b2441;border-radius:12px;padding:10px;position:relative}
    .step.dropping{outline:2px solid #60a5fa}
    .step .handle{width:16px;height:16px;border-radius:4px;background:linear-gradient(180deg,#1f2f55,#162448);border:1px solid #2a3e72;cursor:grab}
    .ordem{position:absolute;left:28px;top:8px;font-weight:800;font-size:11px;color:#cbd5e1;background:#0e1832;border:1px solid #1c2a4d;border-radius:999px;padding:2px 6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .step input[type="text"], .step input[type="number"]{background:#0b1328;border:1px solid #1c2a4d;color:var(--ink);border-radius:8px;padding:8px}
    .step label{font-size:12px;color:#cbd5e1}
    .step .picPrev{width:28px;height:28px;border-radius:6px;background:#0b1220;border:1px solid #1c2a4d;object-fit:contain}
    .step .textDropping{outline:2px dashed #60a5fa}

    .controls{padding:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls .grow{display:flex;gap:10px;flex:1;flex-wrap:wrap}
    button{background:linear-gradient(90deg,var(--acc2),var(--acc));border:none;color:#0a1020;font-weight:800;padding:12px;border-radius:10px;cursor:pointer}
    button.secondary{background:#101a32;color:#d1d5db;border:1px solid #1f2a4d}
    button.warn{background:linear-gradient(90deg,#f97316,#f59e0b);color:#0b1220}
    .btnMove{display:none;padding:8px 10px;font-weight:700}

    /* Pr√©-visualiza√ß√£o */
    .textPreview{min-height:220px;background:#081024;border:1px solid #132046;border-radius:12px;margin:12px;padding:12px;white-space:pre-wrap;line-height:1.55;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, 'Courier New', monospace;font-size:14px;color:#e5e7eb}
    .hint{font-size:12px;color:#9fb4d4;padding:10px}

    /* Cores por tipo */
    .step.t-say{background:linear-gradient(180deg,#203046,#1a2741);border-color:#376ba6}
    .step.t-pause{background:linear-gradient(180deg,#2a2f25,#1c2319);border-color:#677a37}
    .step.t-voice{background:linear-gradient(180deg,#262345,#191a33);border-color:#594c9a}

    /* Hamburger + palette toggle + FAB */
    .iconBtn{background:#101a32;color:#d1d5db;border:1px solid #1f2a4d;border-radius:10px;padding:8px 10px;cursor:pointer}
    .iconBtn:hover{outline:1px solid rgba(96,165,250,.4)}
    body.palette-off main{grid-template-columns:1fr 420px;}
    body.palette-off #panelPalette{display:none;}
    @media (max-width:1200px){ body.palette-off main{grid-template-columns:1fr;} }
    .fab{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:50%;border:1px solid #0b1020;box-shadow:0 10px 30px rgba(0,0,0,.45);background:linear-gradient(90deg,var(--acc2),var(--acc));color:#0a1020;font-weight:900;font-size:20px;display:flex;align-items:center;justify-content:center;z-index:1000}
    .fab:active{transform:translateY(1px)}

    /* Modal Editor de Chips */
    .modal{position:fixed;inset:0;display:none;z-index:1500}
    .modal.show{display:block}
    .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px)}
    .modal .card{position:relative;margin:5vh auto;max-width:min(960px,96vw);background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #0b1020;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.55);padding:12px}
    .modal .head{display:flex;align-items:center;justify-content:space-between;padding:8px 6px 10px;border-bottom:1px solid #0b1020}
    .modal .head h3{margin:0;color:#dbeafe;font-size:16px}
    .modal .body{padding:10px 4px;max-height:60vh;overflow:auto}
    .modal .foot{display:flex;gap:8px;justify-content:flex-end;padding-top:10px;border-top:1px solid #0b1020}

    .chipForm{display:grid;grid-template-columns:120px 90px 1fr 1fr auto;gap:8px;align-items:center;margin-bottom:12px}
    .chipForm select, .chipForm input{background:#0b1328;border:1px solid #1c2a4d;color:var(--ink);border-radius:8px;padding:8px}
    .chipForm button{white-space:nowrap}

    .chipList{display:grid;gap:8px}
    .chipRow{display:grid;grid-template-columns:120px 80px 1fr 1fr 120px;gap:8px;align-items:center;background:#0e1730;border:1px solid #1b2441;border-radius:12px;padding:8px}
    .chipRow input, .chipRow select{background:#0b1328;border:1px solid #1c2a4d;color:var(--ink);border-radius:8px;padding:8px}
    .chipRow .rowActions{display:flex;gap:6px;justify-content:flex-end}

    /* ‚Äî‚Äî‚Äî Responsivo ‚Äî‚Äî‚Äî */
    @media (max-width: 1200px){ main{grid-template-columns:1fr;} }
    @media (max-width: 900px){
      .row{flex-direction:column;align-items:stretch}
      .step input[type="text"], .step input[type="number"]{width:100%}
      .controls{position:sticky;bottom:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(120%) blur(6px);border-top:1px solid #0b1020}
      .controls .grow{flex-direction:column}
      .controls button{width:100%}
      .btnMove{display:inline-flex}
      .chipForm{grid-template-columns:1fr 1fr 1fr;}
      .chipRow{grid-template-columns:1fr 1fr;}
      .chipRow .rowActions{grid-column:1 / -1}
    }
    @media (max-width: 480px){ header h1{font-size:16px} .chip{padding:12px} .textPreview{font-size:13px} }
  </style>
</head>
<body>
  <header>
    <button id="btnMenu" class="iconBtn" aria-pressed="false" aria-label="Mostrar/ocultar paleta">‚ò∞</button>
    <h1>Construtor de Frases por Blocos</h1>
    <span class="pill">TTS no navegador ¬∑ simples e direto</span>
    <button id="btnChipEditor" class="iconBtn" title="Gerir chips">Gerir chips</button>
  </header>

  <main>
    <!-- Paleta -->
    <section class="panel" id="panelPalette">
      <h2>Blocos</h2>
      <div class="palette" id="palette">
        <div class="block" draggable="true" data-type="say">üó£Ô∏è <b>Dizer</b><small>Texto + pictograma (opcional)</small></div>
        <div class="block" draggable="true" data-type="pause">‚è∏Ô∏è <b>Pausa</b><small>Segundos</small></div>
        <div class="block" draggable="true" data-type="voice">üéôÔ∏è <b>Voz/Idioma</b><small>Idioma, velocidade, tom</small></div>
      </div>
      <h3 class="basicHead">Frases b√°sicas</h3>
      <div class="tabs" id="tabs">
        <button class="tab active" data-target="need">Necessidades</button>
        <button class="tab" data-target="social">Sociais</button>
        <button class="tab" data-target="action">A√ß√µes</button>
      </div>
      <div id="chipsWrap">
        <div class="chips chips-cat" id="chips-need"></div>
        <div class="chips chips-cat" id="chips-social" hidden></div>
        <div class="chips chips-cat" id="chips-action" hidden></div>
      </div>
      <div class="hint">Toque num chip para adicionar (arrastar tamb√©m funciona no desktop).</div>
    </section>

    <!-- √Årea de trabalho -->
    <section class="panel">
      <h2>√Årea de Trabalho</h2>
      <div class="workspace">
        <div id="dropzone" class="dropzone" aria-label="workspace" tabindex="0"></div>
      </div>
      <div class="controls">
        <div class="grow">
          <button id="btnPlay">‚ñ∂ Play</button>
          <button id="btnReset" class="warn">Repor</button>
        </div>
        <button id="btnExport" class="secondary">Exportar JSON</button>
        <input id="fileImport" type="file" accept="application/json,.json" style="display:none" />
        <button id="btnImport" class="secondary">Importar JSON</button>
      </div>
      <div class="hint">Execu√ß√£o: l√™ os blocos na ordem. "Voz/Idioma" define a voz atual; "Pausa" espera; "Dizer" fala o texto.</div>
    </section>

    <!-- Pr√©-visualiza√ß√£o -->
    <section class="panel">
      <h2>Pr√©‚Äëvisualiza√ß√£o</h2>
      <div id="preview" class="textPreview" aria-live="polite"></div>
      <div class="hint">A pr√©‚Äëvisualiza√ß√£o mostra o que ser√° dito (pausas surgem como [PAUSA Xs]).</div>
    </section>
  </main>

  <!-- FAB Play -->
  <button id="fabPlay" class="fab" title="Play" aria-label="Play">‚ñ∂</button>

  <!-- Modal Editor de Chips -->
  <div id="chipModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="chipEditorTitle">
    <div class="backdrop"></div>
    <div class="card">
      <div class="head">
        <h3 id="chipEditorTitle">Gerir chips</h3>
        <button id="chipClose" class="iconBtn" aria-label="Fechar">‚úï</button>
      </div>
      <div class="body">
        <div class="chipForm">
          <select id="chipCat">
            <option value="need">Necessidades</option>
            <option value="social">Sociais</option>
            <option value="action">A√ß√µes</option>
          </select>
          <input id="chipEmoji" type="text" placeholder="Emoji" />
          <input id="chipText" type="text" placeholder="Texto" />
          <input id="chipPic" type="text" placeholder="URL pictograma (opcional)" />
          <button id="chipAdd">Adicionar</button>
        </div>
        <div class="chipList" id="chipList"></div>
      </div>
      <div class="foot">
        <input id="chipImportFile" type="file" accept="application/json" style="display:none" />
        <button id="chipImport" class="secondary">Importar</button>
        <button id="chipExport" class="secondary">Exportar</button>
        <button id="chipSave">Guardar e fechar</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // ===== Estado =====
    var steps = []; // {id,type,conf}
    function makeId(){ return 'id_' + Math.random().toString(36).slice(2,9); }

    // ===== Refs =====
    var palette = document.getElementById('palette');
    var dropzone = document.getElementById('dropzone');
    var preview = document.getElementById('preview');
    var btnMenu = document.getElementById('btnMenu');
    var tabs = document.getElementById('tabs');
    var chipsWrap = document.getElementById('chipsWrap');
    var fab = document.getElementById('fabPlay');
    var btnChipEditor = document.getElementById('btnChipEditor');

    // ===== Menu hamb√∫rguer =====
    if (btnMenu) {
      function applyPaletteOff(init){
        var off = document.body.classList.contains('palette-off');
        btnMenu.setAttribute('aria-pressed', off ? 'true':'false');
        if (!init) { try{ localStorage.setItem('paletteOff', off?'1':'0'); }catch(e){} }
      }
      btnMenu.addEventListener('click', function(){
        document.body.classList.toggle('palette-off');
        applyPaletteOff(false);
      });
      try{ if(localStorage.getItem('paletteOff')==='1'){ document.body.classList.add('palette-off'); } }catch(e){}
      applyPaletteOff(true);
    }

    // ===== Chips Store =====
    var CATS = [
      {id:'need', label:'Necessidades'},
      {id:'social', label:'Sociais'},
      {id:'action', label:'A√ß√µes'}
    ];

    function seedDefaultChips(){
      var arr = [
        {text:'Tenho fome.', emoji:'üçΩÔ∏è', pic:'', category:'need'},
        {text:'Tenho sede.', emoji:'üíß', pic:'', category:'need'},
        {text:'Preciso de ir √† casa de banho.', emoji:'üöª', pic:'', category:'need'},
        {text:'D√≥i-me a cabe√ßa.', emoji:'ü§ï', pic:'', category:'need'},
        {text:'Quero √°gua.', emoji:'üö∞', pic:'', category:'need'},
        {text:'Ajuda, por favor.', emoji:'üÜò', pic:'', category:'need'},
        {text:'Estou cansado.', emoji:'üò¥', pic:'', category:'need'},
        {text:'Estou com frio.', emoji:'ü•∂', pic:'', category:'need'},
        {text:'Estou com calor.', emoji:'ü•µ', pic:'', category:'need'},
        {text:'Ol√°!', emoji:'üëã', pic:'', category:'social'},
        {text:'Obrigado.', emoji:'üôè', pic:'', category:'social'},
        {text:'Desculpa.', emoji:'üôá', pic:'', category:'social'},
        {text:'Sim.', emoji:'‚úÖ', pic:'', category:'social'},
        {text:'N√£o.', emoji:'‚ùå', pic:'', category:'social'},
        {text:'Espera, por favor.', emoji:'‚è≥', pic:'', category:'social'},
        {text:'Para, por favor.', emoji:'‚úã', pic:'', category:'social'},
        {text:'Vem aqui, por favor.', emoji:'üëá', pic:'', category:'action'}
      ];
      return arr.map(function(c){ return Object.assign({id:makeId()}, c); });
    }

    function loadChipsStore(){
      try{ var s = JSON.parse(localStorage.getItem('chipsStoreV1')||''); if(s && Array.isArray(s.chips)) return s; }catch(e){}
      var store = {version:1, chips: seedDefaultChips()};
      saveChipsStore(store);
      return store;
    }
    function saveChipsStore(s){ try{ localStorage.setItem('chipsStoreV1', JSON.stringify(s)); }catch(e){} }

    var chipStore = loadChipsStore();

    function chipsByCat(cat){ return chipStore.chips.filter(function(c){ return c.category===cat; }); }

    function renderChipsUIFromStore(){
      ['need','social','action'].forEach(function(cat){
        var cont = document.getElementById('chips-'+cat);
        if(!cont) return;
        cont.innerHTML = '';
        chipsByCat(cat).forEach(function(c){
          var div = document.createElement('div');
          div.className='chip';
          div.setAttribute('draggable','true');
          div.setAttribute('data-phrase', c.text);
          div.setAttribute('data-emoji', c.emoji || '');
          if (c.pic) div.setAttribute('data-pic', c.pic);
          div.innerHTML = '<span class="emo">'+(c.emoji||'üî§')+'</span><span class="txt">'+(c.text||'')+'</span>';
          cont.appendChild(div);
        });
      });
    }

    // ===== Defaults =====
    function defaultConfig(type){
      if(type==='say') return { text:'Ol√°!', emoji:'üó£Ô∏è', pic:'' };
      if(type==='pause') return { seconds:0.8 };
      if(type==='voice') return { lang:'pt-PT', rate:1.0, pitch:1.0 };
      return {};
    }

    // ===== Helpers UI =====
    function L(txt){ var l=document.createElement('label'); l.textContent=txt; return l; }
    function inputText(val, on){ var i=document.createElement('input'); i.type='text'; i.value=val||''; i.oninput=function(){ on(i.value); updatePreview(); }; return i; }
    function inputNum(val, on){ var i=document.createElement('input'); i.type='number'; i.step='0.1'; i.value=val; i.oninput=function(){ on(parseFloat(i.value)); updatePreview(); }; return i; }

    // ===== CRUD de passos =====
    function addStep(type, preset){ steps.push({ id:makeId(), type:type, conf:preset||defaultConfig(type) }); render(); }
    function pretty(type){ return {say:'Dizer', pause:'Pausa', voice:'Voz/Idioma'}[type] || type; }

    function buildConfigUI(st){
      var box = document.createElement('div'); box.className='row'; var c = st.conf;
      if(st.type==='say'){
        var img = document.createElement('img'); img.className='picPrev'; if(c.pic){ img.src=c.pic; } else { img.style.display='none'; }
        var emoji = inputText(c.emoji||'', function(v){ c.emoji=v; }); emoji.style.width='60px';
        var pic = inputText(c.pic||'', function(v){ c.pic=v; img.style.display=v?'block':'none'; img.src=v||''; }); pic.placeholder='URL pictograma (opcional)';
        var text = inputText(c.text||'', function(v){ c.text=v; });
        // Drop no input
        text.addEventListener('dragover', function(e){ e.preventDefault(); text.classList.add('textDropping'); });
        text.addEventListener('dragleave', function(){ text.classList.remove('textDropping'); });
        text.addEventListener('drop', function(e){ e.preventDefault(); text.classList.remove('textDropping'); var payload = readPhrasePayload(e.dataTransfer); if(payload && payload.text){ c.text = (c.text? c.text+' ' : '') + payload.text.trim(); text.value=c.text; updatePreview(); }});
        box.appendChild(img); box.appendChild(L('emoji')); box.appendChild(emoji); box.appendChild(L('pictograma')); box.appendChild(pic); box.appendChild(L('texto')); box.appendChild(text);
      }
      if(st.type==='pause'){
        var secs = inputNum(c.seconds||0.5, function(v){ c.seconds=v; });
        box.appendChild(L('segundos')); box.appendChild(secs);
      }
      if(st.type==='voice'){
        var lang = inputText(c.lang||'pt-PT', function(v){ c.lang=v; });
        var rate = inputNum(c.rate||1.0, function(v){ c.rate=v; });
        var pitch = inputNum(c.pitch||1.0, function(v){ c.pitch=v; });
        box.appendChild(L('idioma')); box.appendChild(lang); box.appendChild(L('velocidade')); box.appendChild(rate); box.appendChild(L('tom')); box.appendChild(pitch);
      }
      return box;
    }

    function moveStep(index, dir){ var to=index+dir; if(to<0||to>=steps.length) return; var m=steps.splice(index,1)[0]; steps.splice(to,0,m); render(); }

    function render(){
      dropzone.innerHTML='';
      if(!steps.length){ dropzone.innerHTML='<div class="hint">Toca num chip para adicionar rapidamente. Ou larga <b>blocos</b>/<b>frases</b> aqui para come√ßar.</div>'; updatePreview(); return; }
      for(var idx=0; idx<steps.length; idx++){
        (function(){
          var st = steps[idx];
          var el = document.createElement('div'); el.className='step t-'+st.type; el.setAttribute('draggable','true');

          // Reordena√ß√£o
          el.addEventListener('dragstart', function(ev){ ev.dataTransfer.setData('text/drag-id', st.id); });
          el.addEventListener('dragover', function(ev){ ev.preventDefault(); el.classList.add('dropping'); });
          el.addEventListener('dragleave', function(){ el.classList.remove('dropping'); });
          el.addEventListener('drop', function(ev){
            ev.preventDefault(); el.classList.remove('dropping');
            var payload = readPhrasePayload(ev.dataTransfer);
            if(payload && payload.text){
              if(st.type==='say'){
                st.conf.text = (st.conf.text ? st.conf.text+' ' : '') + payload.text.trim();
                updatePreview(); render();
              } else {
                steps.splice(idx, 0, { id: makeId(), type:'say', conf:{ text:payload.text, emoji:payload.emoji||'üî§', pic:payload.pic||'' } });
                render();
              }
              return;
            }
            var id = ev.dataTransfer.getData('text/drag-id');
            if(!id) return;
            var from=-1; for(var i=0;i<steps.length;i++){ if(steps[i].id===id){ from=i; break; } }
            if(from>-1){ var m = steps.splice(from,1)[0]; steps.splice(idx,0,m); render(); }
          });

          var ordem = document.createElement('div'); ordem.className='ordem'; ordem.textContent=(idx+1); el.appendChild(ordem);
          var handle = document.createElement('div'); handle.className='handle'; handle.setAttribute('aria-label','Arrastar para reordenar'); el.appendChild(handle);
          var label = document.createElement('div'); label.style.minWidth='140px'; label.style.fontWeight='700'; label.appendChild(document.createTextNode(pretty(st.type))); el.appendChild(label);

          el.appendChild(buildConfigUI(st));

          var actions = document.createElement('div'); actions.style.marginLeft='auto'; actions.style.display='flex'; actions.style.gap='8px';
          var up = document.createElement('button'); up.className='secondary btnMove'; up.textContent='‚Üë'; up.title='Mover para cima'; up.onclick=function(){ moveStep(idx,-1); };
          var down = document.createElement('button'); down.className='secondary btnMove'; down.textContent='‚Üì'; down.title='Mover para baixo'; down.onclick=function(){ moveStep(idx,1); };
          var dup = document.createElement('button'); dup.className='secondary'; dup.textContent='Duplicar'; dup.onclick=function(){ var copy=JSON.parse(JSON.stringify(st)); copy.id=makeId(); steps.splice(idx+1,0,copy); render(); };
          var del = document.createElement('button'); del.className='secondary'; del.textContent='Apagar'; del.onclick=function(){ steps=steps.filter(function(s){ return s.id!==st.id; }); render(); };
          actions.appendChild(up); actions.appendChild(down); actions.appendChild(dup); actions.appendChild(del);
          el.appendChild(actions);

          dropzone.appendChild(el);
        })();
      }
      updatePreview();
    }

    // ===== Pr√©‚Äëvisualiza√ß√£o =====
    function generatePreviewLines(){
      var lines = []; var conf = {lang:'pt-PT', rate:1.0, pitch:1.0};
      for(var i=0;i<steps.length;i++){
        var s=steps[i], c=s.conf||{};
        if(s.type==='voice'){ conf={ lang:c.lang||conf.lang, rate:Number(c.rate||conf.rate)||1.0, pitch:Number(c.pitch||conf.pitch)||1.0 }; }
        else if(s.type==='pause'){ var secs=Math.max(0,Number(c.seconds||0)); if(secs>0) lines.push('[PAUSA '+secs.toFixed(1)+'s]'); }
        else if(s.type==='say'){ var t=(c.text||'').trim(); if(t){ lines.push(t); } }
      }
      return { lines:lines, conf:conf };
    }
function updatePreview(){ var r=generatePreviewLines(); preview.textContent = r.lines.join('\n'); }

    // ===== Drag helpers =====
    function readPhrasePayload(dt){
      if(!dt) return null;
      var raw = dt.getData('application/phrase');
      if(raw){ try{ return JSON.parse(raw); }catch(_){} }
      var txt = dt.getData('text/plain');
      if(txt && txt.indexOf('{')>-1){ try{ var p=JSON.parse(txt); if(p && (p.text||p.phrase)) return { text:p.text||p.phrase, emoji:p.emoji||'üî§', pic:p.pic||'' }; }catch(_){} }
      if(txt && txt.indexOf('PHRASE:')===0){ try{ return JSON.parse(txt.slice(7)); }catch(_){} }
      return null;
    }

    // ===== Paleta: blocos -> click & drag =====
    palette.addEventListener('click', function(e){ var block = e.target.closest('.block'); if(!block) return; var t=block.getAttribute('data-type'); if(t) addStep(t); });
    palette.addEventListener('dragstart', function(e){ var block=e.target.closest('.block'); if(!block) return; e.dataTransfer.setData('text/block-type', block.getAttribute('data-type')); e.dataTransfer.setData('text/plain', 'BLOCK'); e.dataTransfer.effectAllowed='copy'; });

    // ===== Tabs =====
    if (tabs && chipsWrap) {
      tabs.addEventListener('click', function(e){
        var t = e.target.closest('.tab'); if(!t) return;
        var all = tabs.querySelectorAll('.tab'); for(var i=0;i<all.length;i++){ all[i].classList.remove('active'); }
        t.classList.add('active');
        var target = t.getAttribute('data-target');
        ['need','social','action'].forEach(function(cat){ var node=document.getElementById('chips-'+cat); if(node) node.hidden = (cat!==target); });
      });
    }

    // ===== Chips (click & drag delegados) =====
    if (chipsWrap){
      chipsWrap.addEventListener('click', function(e){ var chip=e.target.closest('.chip'); if(!chip) return; addStep('say', { text: chip.getAttribute('data-phrase')||'', emoji: chip.getAttribute('data-emoji')||'üî§', pic: chip.getAttribute('data-pic')||'' }); });
      chipsWrap.addEventListener('dragstart', function(e){ var chip=e.target.closest('.chip'); if(!chip) return; var payload={ text: chip.getAttribute('data-phrase')||'', emoji: chip.getAttribute('data-emoji')||'üî§', pic: chip.getAttribute('data-pic')||'' }; try{ e.dataTransfer.setData('application/phrase', JSON.stringify(payload)); }catch(_){} try{ e.dataTransfer.setData('text/plain', 'PHRASE:'+JSON.stringify(payload)); }catch(_){} e.dataTransfer.effectAllowed='copy'; });
    }

    // ===== Drop na √°rea de trabalho =====
    dropzone.addEventListener('dragover', function(e){ e.preventDefault(); dropzone.classList.add('dropping'); });
    dropzone.addEventListener('dragleave', function(){ dropzone.classList.remove('dropping'); });
    dropzone.addEventListener('drop', function(e){
      e.preventDefault(); dropzone.classList.remove('dropping');
      var pay = readPhrasePayload(e.dataTransfer);
      if(pay && pay.text){ addStep('say', { text:pay.text, emoji:pay.emoji||'üî§', pic:pay.pic||'' }); return; }
      var btype = e.dataTransfer.getData('text/block-type');
      if(btype==='say' || btype==='pause' || btype==='voice'){ addStep(btype); return; }
      var id = e.dataTransfer.getData('text/drag-id');
      if(id){ var from=-1; for(var i=0;i<steps.length;i++){ if(steps[i].id===id){ from=i; break; } } if(from>-1){ var m=steps.splice(from,1)[0]; steps.push(m); render(); } }
    });

    // ===== TTS =====
    function wait(ms){ return new Promise(function(res){ setTimeout(res, ms); }); }
    async function speakLines(){
      if(!('speechSynthesis' in window)){ alert('TTS n√£o suportado neste navegador.'); return; }
      var synth=window.speechSynthesis;
      for(var i=0;i<steps.length;i++){
        var s=steps[i], c=s.conf||{};
        if(s.type==='voice'){
          var want=(c.lang||'pt-PT').toLowerCase(); var voices=synth.getVoices()||[]; var v=null; for(var k=0;k<voices.length;k++){ var vl=(voices[k].lang||'').toLowerCase(); if(vl.indexOf(want)===0){ v=voices[k]; break; } }
          window.__ttsVoice=v||null; window.__ttsLang=c.lang||'pt-PT'; window.__ttsRate=Math.min(2.0,Math.max(0.5,Number(c.rate||1.0))); window.__ttsPitch=Math.min(2.0,Math.max(0.5,Number(c.pitch||1.0)));
        } else if(s.type==='pause'){
          var ms=Math.max(0, Math.round(Number(c.seconds||0)*1000)); if(ms>0) await wait(ms);
        } else if(s.type==='say'){
          var text=(c.text||'').trim(); if(!text) continue; var u=new SpeechSynthesisUtterance(text); u.lang=window.__ttsLang||'pt-PT'; u.rate=window.__ttsRate||1.0; u.pitch=window.__ttsPitch||1.0; if(window.__ttsVoice) u.voice=window.__ttsVoice; await new Promise(function(res){ u.onend=res; u.onerror=res; synth.speak(u); });
        }
      }
    }

    // ===== Bot√µes =====
    document.getElementById('btnPlay').addEventListener('click', function(){ var r=generatePreviewLines(); if(!r.lines.length){ alert('Nada para dizer. Adiciona um bloco "Dizer".'); } else { speakLines(); } });
    if (fab) fab.addEventListener('click', function(){ var r=generatePreviewLines(); if(!r.lines.length){ alert('Nada para dizer. Adiciona um bloco "Dizer".'); } else { speakLines(); } });
    document.getElementById('btnReset').addEventListener('click', function(){ steps=[]; render(); });

    // ===== Export / Import Sequ√™ncia =====
    function exportJSON(){ var payload={ version:1, mode:'tts-blocks', exportedAt:(new Date()).toISOString(), steps:steps }; var blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='frases_blocos.json'; a.click(); URL.revokeObjectURL(a.href); }
    function importJSONFile(file){ if(!file) return; var reader=new FileReader(); reader.onload=function(){ try{ var data=JSON.parse(reader.result); var arr=data&&data.steps; if(!arr||!arr.length){ alert('JSON sem passos.'); return; } steps=arr.map(function(s){ return { id:makeId(), type:s.type, conf:s.conf||defaultConfig(s.type) }; }); render(); }catch(err){ alert('Falha a ler JSON: '+err.message); } }; reader.readAsText(file); }
    document.getElementById('btnExport').addEventListener('click', exportJSON);
    document.getElementById('btnImport').addEventListener('click', function(){ var fi=document.getElementById('fileImport'); fi.value=''; fi.click(); });
    document.getElementById('fileImport').addEventListener('change', function(){ var f=this.files&&this.files[0]; importJSONFile(f); });

    // ===== Editor de Chips =====
    var chipModal = document.getElementById('chipModal');
    var chipClose = document.getElementById('chipClose');
    var chipList = document.getElementById('chipList');
    var chipCat = document.getElementById('chipCat');
    var chipEmoji = document.getElementById('chipEmoji');
    var chipText = document.getElementById('chipText');
    var chipPic = document.getElementById('chipPic');

    function openChipEditor(){
      chipModal.classList.add('show');
      renderChipEditorList();
    }
    function closeChipEditor(){ chipModal.classList.remove('show'); }

    function renderChipEditorList(){
      chipList.innerHTML='';
      CATS.forEach(function(cat){
        var title = document.createElement('div'); title.className='hint'; title.textContent=cat.label; chipList.appendChild(title);
        chipsByCat(cat.id).forEach(function(item){
          var row = document.createElement('div'); row.className='chipRow'; row.dataset.id=item.id;
          row.innerHTML = ''+
            '<select class="cCat">'+
              CATS.map(function(c){ return '<option value="'+c.id+'"'+(c.id===item.category?' selected':'')+'>'+c.label+'</option>'; }).join('')+
            '</select>'+
            '<input class="cEmoji" type="text" value="'+(item.emoji||'')+'" placeholder="Emoji" />'+
            '<input class="cText" type="text" value="'+(item.text||'')+'" placeholder="Texto" />'+
            '<input class="cPic" type="text" value="'+(item.pic||'')+'" placeholder="URL pictograma (opcional)" />'+
            '<div class="rowActions">'+
              '<button class="secondary cUp">‚Üë</button>'+ 
              '<button class="secondary cDown">‚Üì</button>'+ 
              '<button class="secondary cDel">Apagar</button>'+ 
            '</div>';
          chipList.appendChild(row);
        });
      });
    }

    function getItemById(id){ for(var i=0;i<chipStore.chips.length;i++){ if(chipStore.chips[i].id===id) return {item:chipStore.chips[i], idx:i}; } return null; }

    // Delega√ß√£o de eventos na lista
    chipList.addEventListener('input', function(e){
      var row = e.target.closest('.chipRow'); if(!row) return; var id=row.dataset.id; var ref=getItemById(id); if(!ref) return;
      if(e.target.classList.contains('cEmoji')) ref.item.emoji = e.target.value;
      if(e.target.classList.contains('cText')) ref.item.text = e.target.value;
      if(e.target.classList.contains('cPic')) ref.item.pic = e.target.value;
      if(e.target.classList.contains('cCat')) ref.item.category = e.target.value;
    });
    chipList.addEventListener('click', function(e){
      var row = e.target.closest('.chipRow'); if(!row) return; var id=row.dataset.id; var ref=getItemById(id); if(!ref) return;
      if(e.target.classList.contains('cDel')){ chipStore.chips.splice(ref.idx,1); renderChipEditorList(); }
      if(e.target.classList.contains('cUp')){ moveWithinCategory(id,-1); renderChipEditorList(); }
      if(e.target.classList.contains('cDown')){ moveWithinCategory(id,1); renderChipEditorList(); }
    });

    function moveWithinCategory(id, dir){
      var idx = chipStore.chips.findIndex(function(c){ return c.id===id; }); if(idx<0) return;
      var cat = chipStore.chips[idx].category;
      // encontre o vizinho na mesma categoria
      var same = chipStore.chips.map(function(c, i){ return {cat:c.category, i:i}; }).filter(function(o){ return o.cat===cat; }).map(function(o){ return o.i; });
      var pos = same.indexOf(idx); var toPos = pos + dir; if(toPos<0 || toPos>=same.length) return;
      var swapA = same[pos], swapB = same[toPos];
      var tmp = chipStore.chips[swapA]; chipStore.chips[swapA] = chipStore.chips[swapB]; chipStore.chips[swapB] = tmp;
    }

    // Bot√µes do editor
    if(btnChipEditor) btnChipEditor.addEventListener('click', openChipEditor);
    document.getElementById('chipAdd').addEventListener('click', function(){
      var text=(chipText.value||'').trim(); if(!text){ alert('Texto obrigat√≥rio.'); return; }
      chipStore.chips.push({ id:makeId(), text:text, emoji:chipEmoji.value||'', pic:chipPic.value||'', category:chipCat.value||'need' });
      chipText.value=''; chipEmoji.value=''; chipPic.value='';
      renderChipEditorList();
    });
    document.getElementById('chipSave').addEventListener('click', function(){ saveChipsStore(chipStore); renderChipsUIFromStore(); closeChipEditor(); });
    document.getElementById('chipExport').addEventListener('click', function(){
      var payload = { version:1, chips: chipStore.chips.map(function(c){ return { id:c.id, text:c.text, emoji:c.emoji||'', pic:c.pic||'', category:c.category||'need' }; }) };
      var blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='chips_personalizados.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById('chipImport').addEventListener('click', function(){ var fi=document.getElementById('chipImportFile'); fi.value=''; fi.click(); });
    document.getElementById('chipImportFile').addEventListener('change', function(){
      var f=this.files&&this.files[0]; if(!f) return;
      var reader=new FileReader(); reader.onload=function(){
        try{
          var data=JSON.parse(reader.result);
          var list = [];
          if(Array.isArray(data)){ list=data; }
          else if(Array.isArray(data.chips)){ list=data.chips; }
          else if(data.categories){
            Object.keys(data.categories).forEach(function(cat){ var arr=data.categories[cat]||[]; arr.forEach(function(c){ list.push(Object.assign({}, c, {category:cat})); }); });
          }
          if(!list.length){ alert('Ficheiro sem chips.'); return; }
          // normalizar e fundir (dedup por texto+categoria)
          list.forEach(function(c){
            var norm = { id: makeId(), text: String(c.text||'').trim(), emoji: c.emoji||'', pic: c.pic||'', category: (c.category||'need') };
            if(!norm.text) return;
            var exists = chipStore.chips.some(function(x){ return (x.text||'').trim().toLowerCase()===norm.text.toLowerCase() && (x.category||'need')===norm.category; });
            if(!exists) chipStore.chips.push(norm);
          });
          renderChipEditorList(); saveChipsStore(chipStore); renderChipsUIFromStore();
        }catch(err){ alert('Falha a importar: '+err.message); }
      };
      reader.readAsText(f);
    });
    if(chipClose) chipClose.addEventListener('click', closeChipEditor);
    chipModal.querySelector('.backdrop').addEventListener('click', closeChipEditor);

    // ===== Arranque =====
    renderChipsUIFromStore();
    render();
  })();
  </script>
</body>
</html>
