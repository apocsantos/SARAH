<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Comunicador AAC (Crian√ßa)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel2:#121a2f;
      --ink:#e2e8f0; --muted:#94a3b8; --b:#1f2a4d;
      --acc:#22d3ee; --acc2:#60a5fa; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:linear-gradient(180deg,#0b1220,#0a0f1b 30%,#0b1220);color:var(--ink)}
    header{
      display:flex;align-items:center;gap:10px;
      padding:12px 12px;border-bottom:1px solid #111827;
      background:rgba(17,24,39,.75);backdrop-filter:saturate(120%) blur(6px);
      position:sticky;top:0;z-index:10
    }
    header strong{font-size:18px;font-weight:950}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{
      border:none;border-radius:999px;cursor:pointer;
      padding:12px 14px;font-weight:950;font-size:15px;
      background:#101a32;color:#cbd5e1;border:1px solid var(--b);
      display:inline-flex;align-items:center;gap:8px
    }
    .tab.ativa{background:linear-gradient(90deg,var(--acc2),var(--acc));color:#0a1020;border-color:transparent}
    main{max-width:1200px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .barra{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      background:rgba(15,23,42,.85);border:1px solid #0b1020;border-radius:14px;padding:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .frase{
      flex:1;min-height:54px;display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      background:#0d1833;border:1px solid var(--b);border-radius:999px;
      padding:10px 12px;font-weight:950;font-size:16px;cursor:pointer
    }
    .chip img{width:26px;height:26px;object-fit:contain}
    .btn{
      border:none;border-radius:12px;cursor:pointer;
      padding:12px 14px;font-weight:950;font-size:16px
    }
    .btn.principal{background:linear-gradient(90deg,var(--acc2),var(--acc));color:#0a1020}
    .btn.sec{background:#101a32;color:#d1d5db;border:1px solid var(--b)}
    .btn.warn{background:linear-gradient(90deg,#f97316,var(--warn));color:#0b1220}
    .toggle{
      display:inline-flex;align-items:center;gap:8px;
      background:#0d1833;border:1px solid var(--b);border-radius:999px;
      padding:10px 12px;font-weight:900;color:#cbd5e1
    }
    .grade{
      display:grid;gap:14px;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
    }
    .cartao{
      background:linear-gradient(180deg,#0f1830,#0e1730);
      border:1px solid #0b1020;border-radius:18px;
      padding:18px;min-height:170px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;
      cursor:pointer;user-select:none;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05)
    }
    .cartao:hover{outline:2px solid rgba(96,165,250,.35)}
    .cartao img{width:86px;height:86px;object-fit:contain}
    .texto{font-size:20px;font-weight:950;text-align:center;line-height:1.05}
    .nota{font-size:12px;color:var(--muted);padding:0 2px}
    @media (max-width:540px){
      header{flex-wrap:wrap}
      .tab{font-size:14px;padding:12px 12px}
      .grade{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
      .cartao{min-height:160px}
      .texto{font-size:19px}
      .btn{flex:1}
    }
  </style>
</head>
<body>
<header>
  <strong>Comunicador AAC</strong>
  <div class="tabs" id="tabs"></div>
  <div style="flex:1"></div>
  <label class="toggle" title="Se ativado, fala logo ao tocar num cart√£o">
    <input id="falarAoTocar" type="checkbox" checked>
    Falar ao tocar
  </label>
</header>

<main>
  <div class="barra">
    <div class="frase" id="frase"><span class="nota">Toque nos cart√µes para construir uma frase‚Ä¶</span></div>
    <button class="btn principal" id="btnFalar" type="button">üó£Ô∏è Falar</button>
    <button class="btn sec" id="btnApagar" type="button">‚å´</button>
    <button class="btn warn" id="btnLimpar" type="button">Limpar</button>
  </div>

  <div class="grade" id="grade"></div>

  <div class="nota">
    Dica: se estiver no telem√≥vel, use um servidor local (http) em vez de abrir como ficheiro (file://), para o <code>seed.json</code> carregar corretamente.
  </div>
</main>

<script>
(() => {
  const $ = (s, r=document) => r.querySelector(s);

  function falar(texto){
    if(!('speechSynthesis' in window)) { alert('Este navegador n√£o suporta voz.'); return; }
    const u = new SpeechSynthesisUtterance(String(texto||'').trim());
    u.lang = 'pt-PT';
    // iOS/Android podem precisar de gesto do utilizador; isto √© chamado em clique.
    try{ speechSynthesis.cancel(); }catch(e){}
    speechSynthesis.speak(u);
  }

  const estado = { categoria:null, frase:[] };

  fetch('data/seed.json', { cache:'no-store' })
    .then(r => r.json())
    .then(seed => {
      const tabs = $('#tabs');
      const grade = $('#grade');
      const fraseEl = $('#frase');
      const falarAoTocar = $('#falarAoTocar');

      const cats = seed.categorias || [];
      const itens = seed.itens || [];
      estado.categoria = cats[0]?.id || null;

      function desenharSeparadores(){
        tabs.innerHTML = '';
        cats.forEach(c => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'tab' + (c.id === estado.categoria ? ' ativa' : '');
          b.textContent = (c.emoji ? (c.emoji + ' ') : '') + c.nome;
          b.onclick = () => { estado.categoria = c.id; desenharTudo(); };
          tabs.appendChild(b);
        });
      }

      function desenharFrase(){
        fraseEl.innerHTML = '';
        if(!estado.frase.length){
          fraseEl.innerHTML = '<span class="nota">Toque nos cart√µes para construir uma frase‚Ä¶</span>';
          return;
        }
        estado.frase.forEach((t, idx) => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.title = 'Toque para remover';
          chip.innerHTML = (t.icone ? ('<img src="'+t.icone+'" alt="">') : '') + '<span>'+t.texto+'</span>';
          chip.onclick = () => { estado.frase.splice(idx,1); desenharFrase(); };
          fraseEl.appendChild(chip);
        });
      }

      function desenharGrelha(){
        grade.innerHTML = '';
        itens.filter(i => i.categoria === estado.categoria).forEach(i => {
          const card = document.createElement('div');
          card.className = 'cartao';
          card.setAttribute('role','button');
          card.setAttribute('tabindex','0');
          card.setAttribute('aria-label', i.texto);
          card.innerHTML = '<img src="'+i.icone+'" alt=""><div class="texto">'+i.texto+'</div>';
          const onPress = () => {
            estado.frase.push({ texto: i.texto, icone: i.icone });
            desenharFrase();
            if(falarAoTocar.checked) falar(i.texto);
          };
          card.onclick = onPress;
          card.onkeydown = (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onPress(); } };
          grade.appendChild(card);
        });
      }

      function desenharTudo(){
        desenharSeparadores();
        desenharGrelha();
        desenharFrase();
      }

      $('#btnFalar').onclick = () => {
        const txt = estado.frase.map(x=>x.texto).join(' ').trim();
        if(txt) falar(txt);
      };
      $('#btnApagar').onclick = () => { estado.frase.pop(); desenharFrase(); };
      $('#btnLimpar').onclick = () => { estado.frase = []; desenharFrase(); };

      desenharTudo();
    })
    .catch(err => {
      document.body.innerHTML = '<div style="padding:16px;font-family:system-ui;color:#fff;background:#0b1220"><b>Erro a carregar o comunicador.</b><br><br>Prov√°vel causa: abriu o ficheiro diretamente (file://).<br>Use um servidor local (http).<br><br><pre style="white-space:pre-wrap;color:#94a3b8">'+String(err)+'</pre></div>';
    });
})();
</script>
</body>
</html>
